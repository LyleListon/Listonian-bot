{% extends "base.html" %}

{% block title %}Alerts{% endblock %}

{% block styles %}
<style>
.alert-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.alert-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.alert-timestamp {
    font-size: 12px;
    color: #666;
}

.alert-message {
    font-size: 16px;
    margin-bottom: 8px;
}

.alert-details {
    font-size: 14px;
    color: #666;
}

.alert-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 8px;
}

.severity-info {
    color: #2196f3;
}

.severity-warning {
    color: #ff9800;
}

.severity-error {
    color: #f44336;
}

.alert-settings {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.condition-card {
    background: #f5f5f5;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 12px;
}

.condition-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.condition-details {
    font-size: 14px;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    z-index: 1000;
    display: none;
}

.notification.info {
    border-left: 4px solid #2196f3;
}

.notification.warning {
    border-left: 4px solid #ff9800;
}

.notification.error {
    border-left: 4px solid #f44336;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>Alerts</h1>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="fas fa-cog"></i> Alert Settings
            </button>
        </div>
    </div>

    <!-- Alert Filters -->
    <div class="row mb-4">
        <div class="col">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary active" data-filter="all">All</button>
                <button type="button" class="btn btn-outline-secondary" data-filter="unacknowledged">Unacknowledged</button>
                <button type="button" class="btn btn-outline-secondary" data-filter="info">Info</button>
                <button type="button" class="btn btn-outline-secondary" data-filter="warning">Warning</button>
                <button type="button" class="btn btn-outline-secondary" data-filter="error">Error</button>
            </div>
        </div>
    </div>

    <!-- Alert List -->
    <div id="alert-list">
        <!-- Alerts will be inserted here -->
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <div class="notification-content"></div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Alert Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Price Alerts -->
                <h6>Price Alerts</h6>
                <div id="price-conditions">
                    <!-- Price conditions will be inserted here -->
                </div>
                <button class="btn btn-outline-primary btn-sm mb-3" onclick="addCondition('price')">
                    <i class="fas fa-plus"></i> Add Price Alert
                </button>

                <!-- Volume Alerts -->
                <h6>Volume Alerts</h6>
                <div id="volume-conditions">
                    <!-- Volume conditions will be inserted here -->
                </div>
                <button class="btn btn-outline-primary btn-sm mb-3" onclick="addCondition('volume')">
                    <i class="fas fa-plus"></i> Add Volume Alert
                </button>

                <!-- Gas Alerts -->
                <h6>Gas Alerts</h6>
                <div id="gas-conditions">
                    <!-- Gas conditions will be inserted here -->
                </div>
                <button class="btn btn-outline-primary btn-sm mb-3" onclick="addCondition('gas')">
                    <i class="fas fa-plus"></i> Add Gas Alert
                </button>

                <!-- Success Rate Alerts -->
                <h6>Success Rate Alerts</h6>
                <div id="success-rate-conditions">
                    <!-- Success rate conditions will be inserted here -->
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="addCondition('success_rate')">
                    <i class="fas fa-plus"></i> Add Success Rate Alert
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// WebSocket connection
let ws;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 5000;  // 5 seconds

// Alert state
let currentFilter = 'all';
let alerts = [];
let conditions = {};

// Connect to WebSocket
function connectWebSocket() {
    ws = new WebSocket('ws://localhost:8765');
    
    ws.onopen = function() {
        console.log('WebSocket connected');
        reconnectAttempts = 0;
        
        // Subscribe to alerts channel
        ws.send(JSON.stringify({
            action: 'subscribe',
            channel: 'alerts'
        }));
    };
    
    ws.onclose = function() {
        console.log('WebSocket disconnected');
        
        // Attempt reconnection
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`Reconnecting (attempt ${reconnectAttempts})...`);
            setTimeout(connectWebSocket, reconnectDelay);
        }
    };
    
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
    };
    
    ws.onmessage = function(event) {
        try {
            const message = JSON.parse(event.data);
            
            if (message.channel === 'alerts') {
                // Update alerts
                if (Array.isArray(message.data)) {
                    alerts = message.data;
                } else {
                    alerts.push(message.data);
                }
                
                // Update display
                updateAlertList();
                
                // Show notification for new alerts
                if (!Array.isArray(message.data)) {
                    showNotification(message.data);
                }
            }
            
        } catch (error) {
            console.error('Failed to process message:', error);
        }
    };
}

// Update alert list
function updateAlertList() {
    const container = document.getElementById('alert-list');
    container.innerHTML = '';
    
    // Filter alerts
    const filteredAlerts = alerts.filter(alert => {
        if (currentFilter === 'all') return true;
        if (currentFilter === 'unacknowledged') return !alert.acknowledged;
        return alert.severity === currentFilter;
    });
    
    // Sort by timestamp (newest first)
    filteredAlerts.sort((a, b) => b.timestamp - a.timestamp);
    
    // Create alert cards
    for (const alert of filteredAlerts) {
        const card = document.createElement('div');
        card.className = 'alert-card';
        
        const timestamp = new Date(alert.timestamp * 1000).toLocaleString();
        const severityClass = `severity-${alert.severity}`;
        
        card.innerHTML = `
            <div class="alert-header">
                <span class="alert-timestamp">${timestamp}</span>
                <span class="${severityClass}">
                    <i class="fas fa-${alert.severity === 'info' ? 'info-circle' : 
                                    alert.severity === 'warning' ? 'exclamation-triangle' : 
                                    'exclamation-circle'}"></i>
                    ${alert.severity.toUpperCase()}
                </span>
            </div>
            <div class="alert-message">${alert.message}</div>
            <div class="alert-details">
                Type: ${alert.condition.type}<br>
                ${alert.condition.symbol ? `Symbol: ${alert.condition.symbol}<br>` : ''}
                Operator: ${alert.condition.operator}<br>
                Value: ${alert.condition.value}
            </div>
            <div class="alert-actions">
                ${!alert.acknowledged ? `
                    <button class="btn btn-sm btn-outline-primary" onclick="acknowledgeAlert('${alert.timestamp}')">
                        <i class="fas fa-check"></i> Acknowledge
                    </button>
                ` : ''}
            </div>
        `;
        
        container.appendChild(card);
    }
}

// Show notification
function showNotification(alert) {
    const notification = document.getElementById('notification');
    notification.className = `notification ${alert.severity}`;
    
    notification.querySelector('.notification-content').innerHTML = `
        <div class="mb-2"><strong>${alert.severity.toUpperCase()}</strong></div>
        ${alert.message}
    `;
    
    notification.style.display = 'block';
    
    // Hide after 5 seconds
    setTimeout(() => {
        notification.style.display = 'none';
    }, 5000);
}

// Acknowledge alert
function acknowledgeAlert(timestamp) {
    const alert = alerts.find(a => a.timestamp === timestamp);
    if (alert) {
        alert.acknowledged = true;
        updateAlertList();
        
        // Send acknowledgment to server
        fetch('/api/alerts/acknowledge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ timestamp })
        });
    }
}

// Add alert condition
function addCondition(type) {
    const condition = {
        type,
        symbol: type === 'price' || type === 'volume' ? 'WETH' : null,
        operator: 'above',
        value: '0',
        cooldown: 300,
        enabled: true
    };
    
    // Send to server
    fetch('/api/alerts/conditions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(condition)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            conditions[data.name] = condition;
            updateConditionList(type);
        }
    });
}

// Update condition list
function updateConditionList(type) {
    const container = document.getElementById(`${type}-conditions`);
    container.innerHTML = '';
    
    for (const [name, condition] of Object.entries(conditions)) {
        if (condition.type !== type) continue;
        
        const card = document.createElement('div');
        card.className = 'condition-card';
        
        card.innerHTML = `
            <div class="condition-header">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           ${condition.enabled ? 'checked' : ''}
                           onchange="toggleCondition('${name}', this.checked)">
                    <label class="form-check-label">${name}</label>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeCondition('${name}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="condition-details">
                ${condition.symbol ? `Symbol: ${condition.symbol}<br>` : ''}
                Operator: ${condition.operator}<br>
                Value: ${condition.value}<br>
                Cooldown: ${condition.cooldown}s
            </div>
        `;
        
        container.appendChild(card);
    }
}

// Toggle condition
function toggleCondition(name, enabled) {
    if (name in conditions) {
        conditions[name].enabled = enabled;
        
        // Send to server
        fetch('/api/alerts/conditions/' + name, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ enabled })
        });
    }
}

// Remove condition
function removeCondition(name) {
    if (name in conditions) {
        delete conditions[name];
        
        // Send to server
        fetch('/api/alerts/conditions/' + name, {
            method: 'DELETE'
        })
        .then(() => {
            updateConditionList(conditions[name].type);
        });
    }
}

// Filter click handler
document.querySelectorAll('[data-filter]').forEach(button => {
    button.addEventListener('click', function() {
        // Update active state
        document.querySelectorAll('[data-filter]').forEach(b => {
            b.classList.remove('active');
        });
        this.classList.add('active');
        
        // Update filter and refresh
        currentFilter = this.dataset.filter;
        updateAlertList();
    });
});

// Start WebSocket connection
connectWebSocket();

// Load initial conditions
fetch('/api/alerts/conditions')
    .then(response => response.json())
    .then(data => {
        conditions = data;
        for (const type of ['price', 'volume', 'gas', 'success_rate']) {
            updateConditionList(type);
        }
    });

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (ws) {
        ws.close();
    }
});
</script>
{% endblock %}
