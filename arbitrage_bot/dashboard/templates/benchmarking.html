{% extends "base.html" %}

{% block title %}Benchmarking{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.min.css">
<style>
.benchmark-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.chart-container {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-title {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 4px;
}

.metric-change {
    font-size: 14px;
}

.positive-value {
    color: #4caf50;
}

.negative-value {
    color: #f44336;
}

.neutral-value {
    color: #9e9e9e;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Configuration Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="benchmark-card">
                <h4>Benchmark Configuration</h4>
                <form id="benchmark-form">
                    <div class="mb-3">
                        <label class="form-label">Token</label>
                        <select class="form-select" id="token-selector" required>
                            <!-- Token options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="row">
                            <div class="col">
                                <input type="date" class="form-control" id="start-date" required>
                            </div>
                            <div class="col">
                                <input type="date" class="form-control" id="end-date" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Strategy</label>
                        <select class="form-select" id="strategy-selector" required>
                            <option value="current">Current Strategy</option>
                            <option value="optimized">Optimized Strategy</option>
                            <option value="conservative">Conservative Strategy</option>
                            <option value="aggressive">Aggressive Strategy</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">Run Benchmark</button>
                        <button type="button" class="btn btn-outline-primary" onclick="compareStrategies()">
                            Compare Strategies
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-md-6">
            <div class="benchmark-card">
                <h4>Performance Metrics</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-title">Alpha</div>
                            <div class="metric-value" id="alpha">0.00%</div>
                            <div class="metric-change" id="beta">Beta: 0.00</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-title">Information Ratio</div>
                            <div class="metric-value" id="information-ratio">0.00</div>
                            <div class="metric-change" id="tracking-error">Tracking Error: 0.00%</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-title">Sharpe Ratio</div>
                            <div class="metric-value" id="sharpe-ratio">0.00</div>
                            <div class="metric-change" id="sortino-ratio">Sortino: 0.00</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-title">Max Drawdown</div>
                            <div class="metric-value" id="max-drawdown">0.00%</div>
                            <div class="metric-change" id="correlation">Correlation: 0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h4>Cumulative Returns</h4>
                <canvas id="returns-chart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h4>Market Impact</h4>
                <canvas id="impact-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Strategy Comparison -->
    <div class="row">
        <div class="col-12">
            <div class="benchmark-card">
                <h4>Strategy Comparison</h4>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Alpha</th>
                                <th>Beta</th>
                                <th>Sharpe</th>
                                <th>Info Ratio</th>
                                <th>Max DD</th>
                                <th>Win Rate</th>
                                <th>Profit Factor</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table">
                            <!-- Comparison rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// Chart configurations
const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'top',
        }
    }
};

// Initialize charts
let returnsChart, impactChart;

// Format currency
function formatCurrency(num) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(num);
}

// Format percentage
function formatPercent(num) {
    return new Intl.NumberFormat('en-US', {
        style: 'percent',
        minimumFractionDigits: 1,
        maximumFractionDigits: 1
    }).format(num);
}

// Format number
function formatNumber(num) {
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(num);
}

// Show loading overlay
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

// Hide loading overlay
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// Update metrics display
function updateMetrics(metrics) {
    // Update alpha and beta
    document.getElementById('alpha').textContent = formatPercent(metrics.alpha);
    document.getElementById('beta').textContent = `Beta: ${formatNumber(metrics.beta)}`;
    
    // Update information ratio
    document.getElementById('information-ratio').textContent = formatNumber(metrics.information_ratio);
    document.getElementById('tracking-error').textContent = `Tracking Error: ${formatPercent(metrics.tracking_error)}`;
    
    // Update Sharpe ratio
    document.getElementById('sharpe-ratio').textContent = formatNumber(metrics.sharpe_ratio);
    document.getElementById('sortino-ratio').textContent = `Sortino: ${formatNumber(metrics.sortino_ratio)}`;
    
    // Update drawdown
    document.getElementById('max-drawdown').textContent = formatPercent(metrics.max_drawdown);
    document.getElementById('correlation').textContent = `Correlation: ${formatNumber(metrics.correlation)}`;
}

// Update returns chart
function updateReturnsChart(data) {
    const ctx = document.getElementById('returns-chart').getContext('2d');
    if (returnsChart) returnsChart.destroy();
    
    returnsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Strategy',
                data: data.strategy_returns,
                borderColor: '#4caf50',
                tension: 0.1
            }, {
                label: 'Market',
                data: data.market_returns,
                borderColor: '#2196f3',
                tension: 0.1
            }]
        },
        options: chartConfig
    });
}

// Update impact chart
function updateImpactChart(data) {
    const ctx = document.getElementById('impact-chart').getContext('2d');
    if (impactChart) impactChart.destroy();
    
    impactChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Trade Impact',
                data: data.impacts.map(i => ({
                    x: i.size,
                    y: i.impact
                })),
                backgroundColor: '#2196f3'
            }]
        },
        options: {
            ...chartConfig,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Trade Size'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Price Impact'
                    }
                }
            }
        }
    });
}

// Update comparison table
function updateComparisonTable(strategies) {
    const table = document.getElementById('comparison-table');
    table.innerHTML = '';
    
    for (const [name, data] of Object.entries(strategies)) {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${name}</td>
            <td class="${data.metrics.alpha > 0 ? 'positive-value' : 'negative-value'}">
                ${formatPercent(data.metrics.alpha)}
            </td>
            <td>${formatNumber(data.metrics.beta)}</td>
            <td>${formatNumber(data.metrics.sharpe_ratio)}</td>
            <td>${formatNumber(data.metrics.information_ratio)}</td>
            <td class="negative-value">${formatPercent(data.metrics.max_drawdown)}</td>
            <td>${formatPercent(data.metrics.win_rate)}</td>
            <td>${formatNumber(data.metrics.profit_factor)}</td>
        `;
        
        table.appendChild(row);
    }
}

// Run benchmark
async function runBenchmark(event) {
    event.preventDefault();
    showLoading();
    
    try {
        // Get form values
        const symbol = document.getElementById('token-selector').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const strategy = document.getElementById('strategy-selector').value;
        
        // Run benchmark
        const response = await fetch('/api/benchmarking/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                symbol,
                start_date: startDate,
                end_date: endDate,
                strategy
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update display
            updateMetrics(data.data.metrics);
            updateReturnsChart(data.data.returns);
            
            // Get market impact
            const impactResponse = await fetch('/api/benchmarking/impact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    symbol,
                    trades: data.data.trades
                })
            });
            
            const impactData = await impactResponse.json();
            
            if (impactData.success) {
                updateImpactChart(impactData.data);
            }
        } else {
            alert('Failed to run benchmark: ' + data.error);
        }
        
    } catch (error) {
        console.error('Failed to run benchmark:', error);
        alert('Failed to run benchmark: ' + error.message);
    } finally {
        hideLoading();
    }
}

// Compare strategies
async function compareStrategies() {
    showLoading();
    
    try {
        // Get form values
        const symbol = document.getElementById('token-selector').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // Run comparison
        const response = await fetch('/api/benchmarking/compare', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                symbol,
                start_date: startDate,
                end_date: endDate,
                strategies: {
                    'Current': 'current',
                    'Optimized': 'optimized',
                    'Conservative': 'conservative',
                    'Aggressive': 'aggressive'
                }
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            updateComparisonTable(data.data);
        } else {
            alert('Failed to compare strategies: ' + data.error);
        }
        
    } catch (error) {
        console.error('Failed to compare strategies:', error);
        alert('Failed to compare strategies: ' + error.message);
    } finally {
        hideLoading();
    }
}

// Load tokens
async function loadTokens() {
    try {
        const response = await fetch('/api/ml/status');
        const data = await response.json();
        
        if (data.success) {
            const tokens = Object.keys(data.data.tokens || {});
            const selector = document.getElementById('token-selector');
            
            tokens.forEach(token => {
                const option = document.createElement('option');
                option.value = token;
                option.textContent = token;
                selector.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Failed to load tokens:', error);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadTokens();
    document.getElementById('benchmark-form').addEventListener('submit', runBenchmark);
});
</script>
{% endblock %}
