{% extends "base.html" %}

{% block title %}Report Delivery{% endblock %}

{% block styles %}
<style>
.delivery-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.channel-list {
    max-height: 600px;
    overflow-y: auto;
}

.channel-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.channel-item:last-child {
    border-bottom: none;
}

.channel-info {
    flex-grow: 1;
}

.channel-title {
    font-weight: bold;
    margin-bottom: 4px;
}

.channel-meta {
    font-size: 12px;
    color: #666;
}

.channel-actions {
    display: flex;
    gap: 8px;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Channel Configuration Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="delivery-card">
                <h4>Email Configuration</h4>
                <form id="email-form">
                    <div class="mb-3">
                        <label class="form-label">SMTP Host</label>
                        <input type="text" class="form-control" id="smtp-host" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SMTP Port</label>
                        <input type="number" class="form-control" id="smtp-port" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="smtp-username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="smtp-password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">From Address</label>
                        <input type="email" class="form-control" id="from-address" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject Template</label>
                        <select class="form-select" id="subject-template" required>
                            <!-- Subject templates will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Body Template</label>
                        <select class="form-select" id="body-template" required>
                            <!-- Body templates will be inserted here -->
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="use-tls" checked>
                        <label class="form-check-label" for="use-tls">
                            Use TLS
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Email Settings</button>
                    <button type="button" class="btn btn-outline-primary" onclick="testEmail()">Test Email</button>
                </form>
            </div>
        </div>
        <div class="col-md-6">
            <div class="delivery-card">
                <h4>Slack Configuration</h4>
                <form id="slack-form">
                    <div class="mb-3">
                        <label class="form-label">Webhook URL</label>
                        <input type="text" class="form-control" id="webhook-url" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Channel</label>
                        <input type="text" class="form-control" id="slack-channel" placeholder="#reports">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bot Username</label>
                        <select class="form-select" id="slack-username" required>
                            <!-- Username options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Icon</label>
                        <select class="form-select" id="slack-icon" required>
                            <!-- Icon options will be inserted here -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Slack Settings</button>
                    <button type="button" class="btn btn-outline-primary" onclick="testSlack()">Test Slack</button>
                </form>
            </div>
            <div class="delivery-card">
                <h4>Webhook Configuration</h4>
                <form id="webhook-form">
                    <div id="webhook-list">
                        <!-- Webhook entries will be inserted here -->
                    </div>
                    <button type="button" class="btn btn-outline-secondary mb-3" onclick="addWebhook()">
                        Add Webhook
                    </button>
                    <div class="mb-3">
                        <label class="form-label">Timeout</label>
                        <select class="form-select" id="webhook-timeout" required>
                            <!-- Timeout options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Retry Count</label>
                        <select class="form-select" id="webhook-retries" required>
                            <!-- Retry options will be inserted here -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Webhook Settings</button>
                    <button type="button" class="btn btn-outline-primary" onclick="testWebhook()">Test Webhook</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Active Channels -->
    <div class="row">
        <div class="col-12">
            <div class="delivery-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Active Delivery Channels</h4>
                    <button class="btn btn-outline-primary" onclick="refreshChannels()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="channel-list" id="channel-list">
                    <!-- Channel items will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show loading overlay
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

// Hide loading overlay
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// Load defaults
async function loadDefaults() {
    try {
        const response = await fetch('/api/delivery/defaults');
        const data = await response.json();
        
        if (data.success) {
            const defaults = data.data;
            
            // Load email templates
            const subjectSelect = document.getElementById('subject-template');
            const bodySelect = document.getElementById('body-template');
            
            subjectSelect.innerHTML = '';
            bodySelect.innerHTML = '';
            
            defaults.email.subject_templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.value;
                option.textContent = template.label;
                subjectSelect.appendChild(option);
            });
            
            defaults.email.body_templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.value;
                option.textContent = template.label;
                bodySelect.appendChild(option);
            });
            
            // Load Slack options
            const usernameSelect = document.getElementById('slack-username');
            const iconSelect = document.getElementById('slack-icon');
            
            usernameSelect.innerHTML = '';
            iconSelect.innerHTML = '';
            
            defaults.slack.usernames.forEach(username => {
                const option = document.createElement('option');
                option.value = username.value;
                option.textContent = username.label;
                usernameSelect.appendChild(option);
            });
            
            defaults.slack.icons.forEach(icon => {
                const option = document.createElement('option');
                option.value = icon.value;
                option.textContent = icon.label;
                iconSelect.appendChild(option);
            });
            
            // Load webhook options
            const timeoutSelect = document.getElementById('webhook-timeout');
            const retrySelect = document.getElementById('webhook-retries');
            
            timeoutSelect.innerHTML = '';
            retrySelect.innerHTML = '';
            
            defaults.webhook.timeouts.forEach(timeout => {
                const option = document.createElement('option');
                option.value = timeout.value;
                option.textContent = timeout.label;
                timeoutSelect.appendChild(option);
            });
            
            defaults.webhook.retry_counts.forEach(retry => {
                const option = document.createElement('option');
                option.value = retry.value;
                option.textContent = retry.label;
                retrySelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Failed to load defaults:', error);
    }
}

// Add webhook entry
function addWebhook() {
    const list = document.getElementById('webhook-list');
    const entry = document.createElement('div');
    entry.className = 'mb-3';
    entry.innerHTML = `
        <div class="input-group">
            <input type="text" class="form-control webhook-url" placeholder="Webhook URL" required>
            <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    list.appendChild(entry);
}

// Test email configuration
async function testEmail() {
    showLoading();
    
    try {
        const config = {
            smtp_host: document.getElementById('smtp-host').value,
            smtp_port: parseInt(document.getElementById('smtp-port').value),
            smtp_username: document.getElementById('smtp-username').value,
            smtp_password: document.getElementById('smtp-password').value,
            from_address: document.getElementById('from-address').value,
            use_tls: document.getElementById('use-tls').checked
        };
        
        const response = await fetch('/api/delivery/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                channel: 'email',
                test_file: 'test.pdf',
                test_metadata: {
                    recipients: [config.from_address],
                    report_type: 'Test Report'
                }
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.data.test_success) {
                alert('Email test successful');
            } else {
                throw new Error('Email test failed');
            }
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to test email');
        }
        
    } catch (error) {
        console.error('Failed to test email:', error);
        alert(error.message);
    } finally {
        hideLoading();
    }
}

// Test Slack configuration
async function testSlack() {
    showLoading();
    
    try {
        const config = {
            webhook_url: document.getElementById('webhook-url').value,
            channel: document.getElementById('slack-channel').value,
            username: document.getElementById('slack-username').value,
            icon_emoji: document.getElementById('slack-icon').value
        };
        
        const response = await fetch('/api/delivery/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                channel: 'slack',
                test_file: 'test.pdf',
                test_metadata: {
                    report_type: 'Test Report'
                }
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.data.test_success) {
                alert('Slack test successful');
            } else {
                throw new Error('Slack test failed');
            }
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to test Slack');
        }
        
    } catch (error) {
        console.error('Failed to test Slack:', error);
        alert(error.message);
    } finally {
        hideLoading();
    }
}

// Test webhook configuration
async function testWebhook() {
    showLoading();
    
    try {
        const webhooks = Array.from(document.getElementsByClassName('webhook-url'))
            .map(input => input.value)
            .filter(url => url);
            
        if (webhooks.length === 0) {
            throw new Error('No webhooks configured');
        }
        
        const config = {
            webhooks: webhooks.map(url => ({ url })),
            timeout: parseInt(document.getElementById('webhook-timeout').value),
            retry_count: parseInt(document.getElementById('webhook-retries').value)
        };
        
        const response = await fetch('/api/delivery/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                channel: 'webhook',
                test_file: 'test.pdf',
                test_metadata: {
                    report_type: 'Test Report'
                }
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.data.test_success) {
                alert('Webhook test successful');
            } else {
                throw new Error('Webhook test failed');
            }
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to test webhook');
        }
        
    } catch (error) {
        console.error('Failed to test webhook:', error);
        alert(error.message);
    } finally {
        hideLoading();
    }
}

// Refresh channels list
async function refreshChannels() {
    try {
        const response = await fetch('/api/delivery/channels');
        const data = await response.json();
        
        if (data.success) {
            const list = document.getElementById('channel-list');
            list.innerHTML = '';
            
            data.data.forEach(channel => {
                const item = document.createElement('div');
                item.className = 'channel-item';
                item.innerHTML = `
                    <div class="channel-info">
                        <div class="channel-title">${channel.name}</div>
                        <div class="channel-meta">
                            Status: ${channel.enabled ? 'Active' : 'Disabled'}
                        </div>
                    </div>
                    <div class="channel-actions">
                        <button class="btn btn-sm ${channel.enabled ? 'btn-warning' : 'btn-success'}"
                                onclick="toggleChannel('${channel.name}', ${!channel.enabled})">
                            <i class="fas fa-${channel.enabled ? 'pause' : 'play'}"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
    } catch (error) {
        console.error('Failed to refresh channels:', error);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadDefaults();
    document.getElementById('email-form').addEventListener('submit', saveEmailSettings);
    document.getElementById('slack-form').addEventListener('submit', saveSlackSettings);
    document.getElementById('webhook-form').addEventListener('submit', saveWebhookSettings);
    refreshChannels();
});
</script>
{% endblock %}
