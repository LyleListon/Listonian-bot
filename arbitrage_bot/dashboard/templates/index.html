{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2>Performance Overview</h2>
    </div>
</div>

<div class="row">
    <!-- Metrics Cards -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Trades</h5>
                <h2 class="card-text" id="total-trades">{{ metrics.get('total_trades', 0) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">24h Trades</h5>
                <h2 class="card-text" id="trades-24h">{{ metrics.get('trades_24h', 0) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Success Rate</h5>
                <h2 class="card-text" id="success-rate">{{ "%.1f"|format(metrics.get('success_rate', 0) * 100) }}%</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Profit</h5>
                <h2 class="card-text" id="total-profit">${{ "%.2f"|format(metrics.get('total_profit', 0)) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">24h Profit</h5>
                <h2 class="card-text" id="profit-24h">${{ "%.2f"|format(metrics.get('profit_24h', 0)) }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Charts -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Profit History</h5>
                <div id="profit-chart"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Trade Volume History</h5>
                <div id="volume-chart"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize charts when document is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize WebSocket connection
    if (window.wsHandler) {
        // Subscribe to channels
        window.wsHandler.socket.addEventListener('open', () => {
            window.wsHandler.socket.send(JSON.stringify({
                type: 'subscribe',
                channels: ['metrics', 'performance']
            }));
        });

        window.wsHandler.onMetrics((metrics) => {
            // Update metrics display
            document.getElementById('total-trades').textContent = metrics.total_trades;
            document.getElementById('trades-24h').textContent = metrics.trades_24h;
            document.getElementById('success-rate').textContent = `${(metrics.success_rate * 100).toFixed(1)}%`;
            document.getElementById('total-profit').textContent = `$${metrics.total_profit.toFixed(2)}`;
            document.getElementById('profit-24h').textContent = `$${metrics.profit_24h.toFixed(2)}`;
            if (document.getElementById('active-opportunities')) {
                document.getElementById('active-opportunities').textContent = metrics.active_opportunities;
            }
        });

        window.wsHandler.onPerformance((data) => {
            // Update charts
            if (window.profitChart && data.profit_history) {
                window.profitChart.updateSeries([{
                    data: data.profit_history
                }]);
            }
            if (window.volumeChart && data.volume_history) {
                window.volumeChart.updateSeries([{
                    data: data.volume_history
                }]);
            }
        });
    }

    // Initialize charts
    const profitChartOptions = {
        series: [{
            name: 'Profit',
            data: []
        }],
        chart: {
            type: 'line',
            height: 350,
            animations: {
                enabled: true,
                easing: 'easeinout',
                dynamicAnimation: {
                    speed: 1000
                }
            }
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        xaxis: {
            type: 'datetime'
        },
        yaxis: {
            labels: {
                formatter: function(val) {
                    return '$' + val.toFixed(2);
                }
            }
        },
        tooltip: {
            x: {
                format: 'dd MMM yyyy HH:mm'
            }
        }
    };

    // Volume chart options
    const volumeChartOptions = {
        series: [{
            name: 'Volume',
            data: []
        }],
        chart: {
            type: 'bar',
            height: 350,
            animations: {
                enabled: true
            }
        },
        xaxis: {
            type: 'datetime'
        },
        yaxis: {
            labels: {
                formatter: function(val) {
                    return Math.round(val);
                }
            }
        },
        tooltip: {
            x: {
                format: 'dd MMM yyyy HH:mm'
            }
        }
    };

    // Create charts
    window.profitChart = new ApexCharts(document.querySelector("#profit-chart"), profitChartOptions);
    window.volumeChart = new ApexCharts(document.querySelector("#volume-chart"), volumeChartOptions);

    // Render charts
    window.profitChart.render();
    window.volumeChart.render();
});
</script>
{% endblock %}
