{% extends "base.html" %}

{% block title %}Service Integration{% endblock %}

{% block styles %}
<style>
.integration-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.service-list {
    max-height: 600px;
    overflow-y: auto;
}

.service-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.service-item:last-child {
    border-bottom: none;
}

.service-info {
    flex-grow: 1;
}

.service-title {
    font-weight: bold;
    margin-bottom: 4px;
}

.service-meta {
    font-size: 12px;
    color: #666;
}

.service-actions {
    display: flex;
    gap: 8px;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- API Configuration Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="integration-card">
                <h4>API Configuration</h4>
                <form id="api-form">
                    <div class="mb-3">
                        <label class="form-label">Service Name</label>
                        <input type="text" class="form-control" id="service-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Base URL</label>
                        <input type="url" class="form-control" id="base-url" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">API Version</label>
                        <select class="form-select" id="api-version" required>
                            <!-- Version options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Authentication Type</label>
                        <select class="form-select" id="auth-type" required>
                            <!-- Auth type options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3" id="api-key-section" style="display: none;">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-control" id="api-key">
                    </div>
                    <div class="mb-3" id="bearer-token-section" style="display: none;">
                        <label class="form-label">Bearer Token</label>
                        <input type="password" class="form-control" id="bearer-token">
                    </div>
                    <button type="submit" class="btn btn-primary">Save API Settings</button>
                    <button type="button" class="btn btn-outline-primary" onclick="testAPI()">Test API</button>
                </form>
            </div>
        </div>
        <div class="col-md-6">
            <div class="integration-card">
                <h4>Webhook Configuration</h4>
                <form id="webhook-form">
                    <div id="webhook-list">
                        <!-- Webhook entries will be inserted here -->
                    </div>
                    <button type="button" class="btn btn-outline-secondary mb-3" onclick="addWebhook()">
                        Add Webhook
                    </button>
                    <div class="mb-3">
                        <label class="form-label">Timeout</label>
                        <select class="form-select" id="webhook-timeout" required>
                            <!-- Timeout options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Retry Count</label>
                        <select class="form-select" id="webhook-retries" required>
                            <!-- Retry options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Retry Delay</label>
                        <select class="form-select" id="webhook-delay" required>
                            <!-- Delay options will be inserted here -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Webhook Settings</button>
                    <button type="button" class="btn btn-outline-primary" onclick="testWebhook()">Test Webhook</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Active Services -->
    <div class="row">
        <div class="col-12">
            <div class="integration-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Active Services</h4>
                    <button class="btn btn-outline-primary" onclick="refreshServices()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="service-list" id="service-list">
                    <!-- Service items will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show loading overlay
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

// Hide loading overlay
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// Load defaults
async function loadDefaults() {
    try {
        const response = await fetch('/api/integration/defaults');
        const data = await response.json();
        
        if (data.success) {
            const defaults = data.data;
            
            // Load API options
            const versionSelect = document.getElementById('api-version');
            const authSelect = document.getElementById('auth-type');
            
            versionSelect.innerHTML = '';
            authSelect.innerHTML = '';
            
            defaults.api.versions.forEach(version => {
                const option = document.createElement('option');
                option.value = version.value;
                option.textContent = version.label;
                versionSelect.appendChild(option);
            });
            
            defaults.api.auth_types.forEach(auth => {
                const option = document.createElement('option');
                option.value = auth.value;
                option.textContent = auth.label;
                authSelect.appendChild(option);
            });
            
            // Load webhook options
            const timeoutSelect = document.getElementById('webhook-timeout');
            const retrySelect = document.getElementById('webhook-retries');
            const delaySelect = document.getElementById('webhook-delay');
            
            timeoutSelect.innerHTML = '';
            retrySelect.innerHTML = '';
            delaySelect.innerHTML = '';
            
            defaults.webhook.timeouts.forEach(timeout => {
                const option = document.createElement('option');
                option.value = timeout.value;
                option.textContent = timeout.label;
                timeoutSelect.appendChild(option);
            });
            
            defaults.webhook.retry_counts.forEach(retry => {
                const option = document.createElement('option');
                option.value = retry.value;
                option.textContent = retry.label;
                retrySelect.appendChild(option);
            });
            
            defaults.webhook.retry_delays.forEach(delay => {
                const option = document.createElement('option');
                option.value = delay.value;
                option.textContent = delay.label;
                delaySelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Failed to load defaults:', error);
    }
}

// Toggle auth sections
document.getElementById('auth-type').addEventListener('change', function() {
    const apiKeySection = document.getElementById('api-key-section');
    const bearerSection = document.getElementById('bearer-token-section');
    
    apiKeySection.style.display = 'none';
    bearerSection.style.display = 'none';
    
    if (this.value === 'api_key') {
        apiKeySection.style.display = 'block';
    } else if (this.value === 'bearer') {
        bearerSection.style.display = 'block';
    }
});

// Add webhook entry
function addWebhook() {
    const list = document.getElementById('webhook-list');
    const entry = document.createElement('div');
    entry.className = 'mb-3';
    entry.innerHTML = `
        <div class="input-group">
            <input type="text" class="form-control webhook-url" placeholder="Webhook URL" required>
            <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    list.appendChild(entry);
}

// Test API configuration
async function testAPI() {
    showLoading();
    
    try {
        const config = {
            service: document.getElementById('service-name').value,
            base_url: document.getElementById('base-url').value,
            version: document.getElementById('api-version').value,
            auth_type: document.getElementById('auth-type').value
        };
        
        if (config.auth_type === 'api_key') {
            config.api_key = document.getElementById('api-key').value;
        } else if (config.auth_type === 'bearer') {
            config.bearer_token = document.getElementById('bearer-token').value;
        }
        
        const response = await fetch('/api/integration/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                service: config.service
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.data.test_success) {
                alert('API test successful');
            } else {
                throw new Error('API test failed');
            }
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to test API');
        }
        
    } catch (error) {
        console.error('Failed to test API:', error);
        alert(error.message);
    } finally {
        hideLoading();
    }
}

// Test webhook configuration
async function testWebhook() {
    showLoading();
    
    try {
        const webhooks = Array.from(document.getElementsByClassName('webhook-url'))
            .map(input => input.value)
            .filter(url => url);
            
        if (webhooks.length === 0) {
            throw new Error('No webhooks configured');
        }
        
        const response = await fetch('/api/integration/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                service: 'webhook'
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.data.test_success) {
                alert('Webhook test successful');
            } else {
                throw new Error('Webhook test failed');
            }
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to test webhook');
        }
        
    } catch (error) {
        console.error('Failed to test webhook:', error);
        alert(error.message);
    } finally {
        hideLoading();
    }
}

// Refresh services list
async function refreshServices() {
    try {
        const response = await fetch('/api/integration/services');
        const data = await response.json();
        
        if (data.success) {
            const list = document.getElementById('service-list');
            list.innerHTML = '';
            
            data.data.forEach(service => {
                const item = document.createElement('div');
                item.className = 'service-item';
                item.innerHTML = `
                    <div class="service-info">
                        <div class="service-title">${service.name}</div>
                        <div class="service-meta">
                            Status: ${service.enabled ? 'Active' : 'Disabled'}
                        </div>
                    </div>
                    <div class="service-actions">
                        <button class="btn btn-sm ${service.enabled ? 'btn-warning' : 'btn-success'}"
                                onclick="toggleService('${service.name}', ${!service.enabled})">
                            <i class="fas fa-${service.enabled ? 'pause' : 'play'}"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
    } catch (error) {
        console.error('Failed to refresh services:', error);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadDefaults();
    document.getElementById('api-form').addEventListener('submit', saveAPISettings);
    document.getElementById('webhook-form').addEventListener('submit', saveWebhookSettings);
    refreshServices();
});
</script>
{% endblock %}
