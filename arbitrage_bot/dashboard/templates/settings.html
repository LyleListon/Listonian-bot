<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Arbitrage Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <h1 class="text-xl font-bold text-gray-800">Arbitrage Bot</h1>
                        </div>
                        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                            <a href="/" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                                Dashboard
                            </a>
                            <a href="/opportunities" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                                Opportunities
                            </a>
                            <a href="/history" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                                History
                            </a>
                            <a href="/settings" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                                Settings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Settings Form -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Bot Settings</h3>
                    <p class="mt-1 max-w-2xl text-sm text-gray-500">Configure trading parameters and bot behavior.</p>
                </div>

                <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
                    <form id="settings-form" class="space-y-8">
                        <!-- Trading Parameters -->
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-4">Trading Parameters</h4>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                <div>
                                    <label for="min-profit" class="block text-sm font-medium text-gray-700">Minimum Profit (USD)</label>
                                    <input type="number" step="0.01" name="min-profit" id="min-profit" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="max-trade-size" class="block text-sm font-medium text-gray-700">Maximum Trade Size (USD)</label>
                                    <input type="number" step="0.01" name="max-trade-size" id="max-trade-size" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="slippage" class="block text-sm font-medium text-gray-700">Slippage Tolerance (%)</label>
                                    <input type="number" step="0.1" name="slippage" id="slippage" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="max-price-impact" class="block text-sm font-medium text-gray-700">Maximum Price Impact (%)</label>
                                    <input type="number" step="0.1" name="max-price-impact" id="max-price-impact" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                            </div>
                        </div>

                        <!-- Gas Settings -->
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-4">Gas Settings</h4>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                <div>
                                    <label for="max-gas-price" class="block text-sm font-medium text-gray-700">Maximum Gas Price (GWEI)</label>
                                    <input type="number" name="max-gas-price" id="max-gas-price" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="gas-limit" class="block text-sm font-medium text-gray-700">Gas Limit</label>
                                    <input type="number" name="gas-limit" id="gas-limit" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                            </div>
                        </div>

                        <!-- DEX Settings -->
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-4">DEX Settings</h4>
                            <div class="space-y-4" id="dex-settings">
                                <!-- DEX settings will be inserted here -->
                            </div>
                        </div>

                        <!-- Token Settings -->
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-4">Token Settings</h4>
                            <div class="space-y-4" id="token-settings">
                                <!-- Token settings will be inserted here -->
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="pt-5">
                            <div class="flex justify-end">
                                <button type="submit" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Save Settings
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        const socket = io();
        let currentSettings = {};

        socket.on('connect', () => {
            console.log('Connected to server');
            loadSettings();
        });

        socket.on('settings_update', (settings) => {
            currentSettings = settings;
            populateForm(settings);
        });

        socket.on('settings_error', (error) => {
            alert(`Error: ${error}`);
        });

        socket.on('settings_saved', () => {
            showNotification('Settings saved successfully');
        });

        function loadSettings() {
            socket.emit('get_settings');
        }

        function populateForm(settings) {
            // Trading Parameters
            document.getElementById('min-profit').value = settings.trading?.min_profit_usd || '';
            document.getElementById('max-trade-size').value = settings.trading?.max_trade_size_usd || '';
            document.getElementById('slippage').value = (settings.trading?.slippage_tolerance * 100) || '';
            document.getElementById('max-price-impact').value = (settings.trading?.max_price_impact * 100) || '';

            // Gas Settings
            document.getElementById('max-gas-price').value = settings.gas?.max_fee || '';
            document.getElementById('gas-limit').value = settings.gas?.gas_limit || '';

            // DEX Settings
            const dexContainer = document.getElementById('dex-settings');
            dexContainer.innerHTML = Object.entries(settings.dexes || {}).map(([dex, config]) => `
                <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 rounded-lg">
                    <div class="flex items-center">
                        <input type="checkbox" id="${dex}-enabled" name="${dex}-enabled" 
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                               ${config.enabled ? 'checked' : ''}>
                        <label for="${dex}-enabled" class="ml-2 block text-sm text-gray-900">${dex}</label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Priority</label>
                        <input type="number" id="${dex}-priority" name="${dex}-priority" 
                               value="${config.priority || ''}"
                               class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Min Liquidity (USD)</label>
                        <input type="number" id="${dex}-min-liquidity" name="${dex}-min-liquidity" 
                               value="${config.min_liquidity_usd || ''}"
                               class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
            `).join('');

            // Token Settings
            const tokenContainer = document.getElementById('token-settings');
            tokenContainer.innerHTML = Object.entries(settings.tokens || {}).map(([token, config]) => `
                <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-900">${token}</span>
                        <span class="ml-2 text-sm text-gray-500">${config.address}</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Min Amount</label>
                        <input type="number" id="${token}-min-amount" name="${token}-min-amount" 
                               value="${config.min_amount || ''}"
                               class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Max Amount</label>
                        <input type="number" id="${token}-max-amount" name="${token}-max-amount" 
                               value="${config.max_amount || ''}"
                               class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('settings-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = {
                trading: {
                    min_profit_usd: parseFloat(document.getElementById('min-profit').value),
                    max_trade_size_usd: parseFloat(document.getElementById('max-trade-size').value),
                    slippage_tolerance: parseFloat(document.getElementById('slippage').value) / 100,
                    max_price_impact: parseFloat(document.getElementById('max-price-impact').value) / 100
                },
                gas: {
                    max_fee: parseInt(document.getElementById('max-gas-price').value),
                    gas_limit: parseInt(document.getElementById('gas-limit').value)
                },
                dexes: {},
                tokens: {}
            };

            // Collect DEX settings
            Object.keys(currentSettings.dexes || {}).forEach(dex => {
                formData.dexes[dex] = {
                    enabled: document.getElementById(`${dex}-enabled`).checked,
                    priority: parseInt(document.getElementById(`${dex}-priority`).value),
                    min_liquidity_usd: parseFloat(document.getElementById(`${dex}-min-liquidity`).value)
                };
            });

            // Collect token settings
            Object.keys(currentSettings.tokens || {}).forEach(token => {
                formData.tokens[token] = {
                    ...currentSettings.tokens[token],
                    min_amount: document.getElementById(`${token}-min-amount`).value,
                    max_amount: document.getElementById(`${token}-max-amount`).value
                };
            });

            socket.emit('save_settings', formData);
        });

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transition-opacity duration-500';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
