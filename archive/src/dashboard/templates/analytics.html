{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.min.css">
<style>
.chart-container {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-title {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 4px;
}

.metric-change {
    font-size: 14px;
}

.positive-change {
    color: #4caf50;
}

.negative-change {
    color: #f44336;
}

.trend-indicator {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.trend-up {
    background: #e8f5e9;
    color: #4caf50;
}

.trend-down {
    background: #ffebee;
    color: #f44336;
}

.trend-sideways {
    background: #f5f5f5;
    color: #9e9e9e;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Analytics Dashboard</h1>

    <!-- Summary Section -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">Portfolio Value</div>
                <div class="metric-value" id="portfolio-value">$0.00</div>
                <div class="metric-change" id="portfolio-change">0.00%</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">Total Profit</div>
                <div class="metric-value" id="total-profit">$0.00</div>
                <div class="metric-change" id="profit-change">0.00%</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">Success Rate</div>
                <div class="metric-value" id="success-rate">0%</div>
                <div class="metric-change" id="success-change">0.00%</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">Gas Cost (24h)</div>
                <div class="metric-value" id="gas-cost">0 ETH</div>
                <div class="metric-change" id="gas-change">0.00%</div>
            </div>
        </div>
    </div>

    <!-- Performance Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h4>Portfolio Performance</h4>
                <canvas id="portfolio-chart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h4>Trade Performance</h4>
                <canvas id="trades-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Market Analysis -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h4>Market Trends</h4>
                <canvas id="market-chart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h4>Gas Analysis</h4>
                <canvas id="gas-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Token Analysis -->
    <div class="row" id="token-analysis">
        <!-- Token cards will be inserted here -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// Chart configurations
const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'top',
        }
    }
};

// Initialize charts
let portfolioChart, tradesChart, marketChart, gasChart;

// Format numbers
function formatNumber(num, decimals = 2) {
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(num);
}

// Format currency
function formatCurrency(num) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(num);
}

// Update summary metrics
function updateSummary(data) {
    document.getElementById('portfolio-value').textContent = formatCurrency(data.performance.portfolio_value);
    document.getElementById('portfolio-change').textContent = `${formatNumber(data.performance.portfolio_change * 100)}%`;
    document.getElementById('total-profit').textContent = formatCurrency(data.performance.total_profit);
    document.getElementById('success-rate').textContent = `${formatNumber(data.performance.success_rate * 100)}%`;
    document.getElementById('gas-cost').textContent = `${formatNumber(data.gas.total_cost, 4)} ETH`;
}

// Update performance chart
function updatePerformanceChart(data) {
    const ctx = document.getElementById('portfolio-chart').getContext('2d');
    if (portfolioChart) portfolioChart.destroy();
    
    portfolioChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.timestamps,
            datasets: [{
                label: 'Portfolio Value',
                data: data.portfolio_value,
                borderColor: '#4caf50',
                tension: 0.1
            }]
        },
        options: chartConfig
    });
}

// Update trades chart
function updateTradesChart(data) {
    const ctx = document.getElementById('trades-chart').getContext('2d');
    if (tradesChart) tradesChart.destroy();
    
    tradesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.timestamps,
            datasets: [{
                label: 'Number of Trades',
                data: data.trades,
                backgroundColor: '#2196f3'
            }]
        },
        options: chartConfig
    });
}

// Update market chart
function updateMarketChart(data) {
    const ctx = document.getElementById('market-chart').getContext('2d');
    if (marketChart) marketChart.destroy();
    
    marketChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.timestamps,
            datasets: [{
                label: 'Price',
                data: data.prices,
                borderColor: '#9c27b0',
                tension: 0.1
            }]
        },
        options: chartConfig
    });
}

// Update gas chart
function updateGasChart(data) {
    const ctx = document.getElementById('gas-chart').getContext('2d');
    if (gasChart) gasChart.destroy();
    
    gasChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.timestamps,
            datasets: [{
                label: 'Gas Price (GWEI)',
                data: data.gas_prices,
                borderColor: '#ff9800',
                tension: 0.1
            }]
        },
        options: chartConfig
    });
}

// Update token analysis
function updateTokenAnalysis(data) {
    const container = document.getElementById('token-analysis');
    container.innerHTML = '';
    
    for (const [symbol, metrics] of Object.entries(data)) {
        const card = document.createElement('div');
        card.className = 'col-md-4 mb-4';
        
        const trendClass = metrics.trend.direction === 'up' ? 'trend-up' : 
                          metrics.trend.direction === 'down' ? 'trend-down' : 
                          'trend-sideways';
        
        card.innerHTML = `
            <div class="metric-card">
                <h5>${symbol}</h5>
                <div class="row">
                    <div class="col-6">
                        <div class="metric-title">Price</div>
                        <div class="metric-value">${formatCurrency(metrics.price.current)}</div>
                        <div class="metric-change ${metrics.price.change >= 0 ? 'positive-change' : 'negative-change'}">
                            ${formatNumber(metrics.price.change * 100)}%
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-title">Trend</div>
                        <div class="trend-indicator ${trendClass}">
                            ${metrics.trend.direction.toUpperCase()}
                        </div>
                        <div class="metric-change">
                            Strength: ${formatNumber(metrics.trend.strength * 100)}%
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="metric-title">Volume</div>
                        <div class="metric-value">${formatCurrency(metrics.volume.current)}</div>
                    </div>
                    <div class="col-6">
                        <div class="metric-title">Liquidity</div>
                        <div class="metric-value">${formatCurrency(metrics.liquidity.current)}</div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    }
}

// Fetch and update data
async function updateData() {
    try {
        // Get summary
        const summaryResponse = await fetch('/api/analytics/summary');
        const summaryData = await summaryResponse.json();
        if (summaryData.success) {
            updateSummary(summaryData.data);
        }
        
        // Get performance metrics
        const performanceResponse = await fetch('/api/analytics/performance');
        const performanceData = await performanceResponse.json();
        if (performanceData.success) {
            updatePerformanceChart(performanceData.data);
            updateTradesChart(performanceData.data);
        }
        
        // Get gas metrics
        const gasResponse = await fetch('/api/analytics/gas');
        const gasData = await gasResponse.json();
        if (gasData.success) {
            updateGasChart(gasData.data);
        }
        
        // Get trend analysis
        const trendsResponse = await fetch('/api/analytics/trends');
        const trendsData = await trendsResponse.json();
        if (trendsData.success) {
            updateTokenAnalysis(trendsData.data);
        }
        
    } catch (error) {
        console.error('Failed to update analytics:', error);
    }
}

// WebSocket connection
let ws;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 5000;  // 5 seconds

function connectWebSocket() {
    ws = new WebSocket('ws://localhost:8765');
    
    ws.onopen = function() {
        console.log('WebSocket connected');
        reconnectAttempts = 0;
        
        // Subscribe to channels
        ws.send(JSON.stringify({
            action: 'subscribe',
            channel: 'performance'
        }));
        ws.send(JSON.stringify({
            action: 'subscribe',
            channel: 'market'
        }));
        ws.send(JSON.stringify({
            action: 'subscribe',
            channel: 'gas'
        }));
        ws.send(JSON.stringify({
            action: 'subscribe',
            channel: 'summary'
        }));
    };
    
    ws.onclose = function() {
        console.log('WebSocket disconnected');
        
        // Attempt reconnection
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`Reconnecting (attempt ${reconnectAttempts})...`);
            setTimeout(connectWebSocket, reconnectDelay);
        } else {
            console.error('Max reconnection attempts reached');
            // Fallback to polling
            updateData();
            setInterval(updateData, 30000);
        }
    };
    
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
    };
    
    ws.onmessage = function(event) {
        try {
            const message = JSON.parse(event.data);
            
            switch (message.channel) {
                case 'performance':
                    updatePerformanceChart(message.data);
                    updateTradesChart(message.data);
                    break;
                    
                case 'market':
                    updateMarketChart(message.data);
                    break;
                    
                case 'gas':
                    updateGasChart(message.data);
                    break;
                    
                case 'summary':
                    updateSummary(message.data);
                    updateTokenAnalysis(message.data.market);
                    break;
            }
            
        } catch (error) {
            console.error('Failed to process message:', error);
        }
    };
}

// Start WebSocket connection
connectWebSocket();

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (ws) {
        ws.close();
    }
});
</script>
{% endblock %}
