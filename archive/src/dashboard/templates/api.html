{% extends "base.html" %}

{% block title %}API Management{% endblock %}

{% block styles %}
<style>
.api-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.key-list {
    max-height: 600px;
    overflow-y: auto;
}

.key-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.key-item:last-child {
    border-bottom: none;
}

.key-info {
    flex-grow: 1;
}

.key-title {
    font-weight: bold;
    margin-bottom: 4px;
}

.key-meta {
    font-size: 12px;
    color: #666;
}

.key-actions {
    display: flex;
    gap: 8px;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- API Configuration Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="api-card">
                <h4>Authentication Settings</h4>
                <form id="auth-form">
                    <div class="mb-3">
                        <label class="form-label">Token Expiry</label>
                        <select class="form-select" id="token-expiry" required>
                            <!-- Token expiry options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Secret Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="secret-key" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleSecretKey()">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Default Role</label>
                        <select class="form-select" id="default-role" required>
                            <!-- Role options will be inserted here -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Auth Settings</button>
                </form>
            </div>
        </div>
        <div class="col-md-6">
            <div class="api-card">
                <h4>CORS Configuration</h4>
                <form id="cors-form">
                    <div class="mb-3">
                        <label class="form-label">Allowed Origins</label>
                        <select class="form-select" id="cors-origins" required>
                            <!-- Origin options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Allowed Methods</label>
                        <select class="form-select" id="cors-methods" required>
                            <!-- Method options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Allowed Headers</label>
                        <select class="form-select" id="cors-headers" required>
                            <!-- Header options will be inserted here -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save CORS Settings</button>
                </form>
            </div>
        </div>
    </div>

    <!-- API Key Management -->
    <div class="row">
        <div class="col-12">
            <div class="api-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>API Keys</h4>
                    <button class="btn btn-primary" onclick="showCreateKeyModal()">
                        <i class="fas fa-plus"></i> Create API Key
                    </button>
                </div>
                <div class="key-list" id="key-list">
                    <!-- API key items will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create API Key Modal -->
    <div class="modal fade" id="create-key-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create API Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-key-form">
                        <div class="mb-3">
                            <label class="form-label">Key Name</label>
                            <input type="text" class="form-control" id="key-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Expiration</label>
                            <select class="form-select" id="key-expiry" required>
                                <!-- Key expiry options will be inserted here -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createAPIKey()">Create</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show loading overlay
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

// Hide loading overlay
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// Toggle secret key visibility
function toggleSecretKey() {
    const input = document.getElementById('secret-key');
    const icon = document.querySelector('#secret-key + button i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Load defaults
async function loadDefaults() {
    try {
        const response = await fetch('/api/v1/defaults');
        const data = await response.json();
        
        if (data.success) {
            const defaults = data.data;
            
            // Load auth options
            const tokenSelect = document.getElementById('token-expiry');
            const roleSelect = document.getElementById('default-role');
            const keySelect = document.getElementById('key-expiry');
            
            tokenSelect.innerHTML = '';
            roleSelect.innerHTML = '';
            keySelect.innerHTML = '';
            
            defaults.auth.token_expiry.forEach(expiry => {
                const option = document.createElement('option');
                option.value = expiry.value;
                option.textContent = expiry.label;
                tokenSelect.appendChild(option);
            });
            
            defaults.auth.roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.value;
                option.textContent = role.label;
                roleSelect.appendChild(option);
            });
            
            defaults.auth.key_expiry.forEach(expiry => {
                const option = document.createElement('option');
                option.value = expiry.value;
                option.textContent = expiry.label;
                keySelect.appendChild(option);
            });
            
            // Load CORS options
            const originsSelect = document.getElementById('cors-origins');
            const methodsSelect = document.getElementById('cors-methods');
            const headersSelect = document.getElementById('cors-headers');
            
            originsSelect.innerHTML = '';
            methodsSelect.innerHTML = '';
            headersSelect.innerHTML = '';
            
            defaults.cors.origins.forEach(origin => {
                const option = document.createElement('option');
                option.value = origin.value;
                option.textContent = origin.label;
                originsSelect.appendChild(option);
            });
            
            defaults.cors.methods.forEach(method => {
                const option = document.createElement('option');
                option.value = method.value;
                option.textContent = method.label;
                methodsSelect.appendChild(option);
            });
            
            defaults.cors.headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header.value;
                option.textContent = header.label;
                headersSelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Failed to load defaults:', error);
    }
}

// Show create key modal
function showCreateKeyModal() {
    const modal = new bootstrap.Modal(document.getElementById('create-key-modal'));
    modal.show();
}

// Create API key
async function createAPIKey() {
    showLoading();
    
    try {
        const request = {
            name: document.getElementById('key-name').value,
            expires_in_days: parseInt(document.getElementById('key-expiry').value)
        };
        
        const response = await fetch('/api/v1/auth/api-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(request)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Show key to user
            alert(`Your API key: ${result.data.key}\n\nPlease save this key as it won't be shown again.`);
            
            // Close modal and refresh list
            bootstrap.Modal.getInstance(document.getElementById('create-key-modal')).hide();
            document.getElementById('create-key-form').reset();
            refreshAPIKeys();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create API key');
        }
        
    } catch (error) {
        console.error('Failed to create API key:', error);
        alert(error.message);
    } finally {
        hideLoading();
    }
}

// Delete API key
async function deleteAPIKey(key) {
    if (!confirm('Are you sure you want to delete this API key?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/auth/api-key/${key}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            refreshAPIKeys();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete API key');
        }
        
    } catch (error) {
        console.error('Failed to delete API key:', error);
        alert(error.message);
    }
}

// Refresh API keys list
async function refreshAPIKeys() {
    try {
        const response = await fetch('/api/v1/auth/api-keys');
        const data = await response.json();
        
        if (data.success) {
            const list = document.getElementById('key-list');
            list.innerHTML = '';
            
            data.data.forEach(key => {
                const item = document.createElement('div');
                item.className = 'key-item';
                item.innerHTML = `
                    <div class="key-info">
                        <div class="key-title">${key.name}</div>
                        <div class="key-meta">
                            Key: ${key.key.substring(0, 8)}...
                            ${key.expires_at ? `| Expires: ${new Date(key.expires_at).toLocaleDateString()}` : ''}
                        </div>
                    </div>
                    <div class="key-actions">
                        <button class="btn btn-sm btn-danger" onclick="deleteAPIKey('${key.key}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
    } catch (error) {
        console.error('Failed to refresh API keys:', error);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadDefaults();
    document.getElementById('auth-form').addEventListener('submit', saveAuthSettings);
    document.getElementById('cors-form').addEventListener('submit', saveCORSSettings);
    refreshAPIKeys();
});
</script>
{% endblock %}
