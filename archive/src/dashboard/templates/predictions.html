{% extends "base.html" %}

{% block title %}Predictions{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.min.css">
<style>
.prediction-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.prediction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.prediction-title {
    font-size: 18px;
    font-weight: bold;
}

.chart-container {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.pattern-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.pattern-indicator {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.pattern-uptrend {
    background: #e8f5e9;
    color: #4caf50;
}

.pattern-downtrend {
    background: #ffebee;
    color: #f44336;
}

.pattern-sideways {
    background: #f5f5f5;
    color: #9e9e9e;
}

.risk-meter {
    width: 100%;
    height: 8px;
    background: #f5f5f5;
    border-radius: 4px;
    margin: 8px 0;
    overflow: hidden;
}

.risk-level {
    height: 100%;
    transition: width 0.3s ease;
}

.risk-low {
    background: #4caf50;
}

.risk-medium {
    background: #ff9800;
}

.risk-high {
    background: #f44336;
}

.recommendation-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.recommendation-action {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 8px;
}

.confidence-meter {
    width: 100%;
    height: 8px;
    background: #f5f5f5;
    border-radius: 4px;
    margin: 8px 0;
    overflow: hidden;
}

.confidence-level {
    height: 100%;
    background: #2196f3;
    transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>Predictions & Analysis</h1>
        </div>
        <div class="col-auto">
            <select class="form-select" id="token-selector">
                <!-- Token options will be inserted here -->
            </select>
        </div>
    </div>

    <!-- Price Predictions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-container">
                <div class="prediction-header">
                    <div class="prediction-title">Price Predictions</div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" data-timeframe="12">12h</button>
                        <button class="btn btn-outline-secondary" data-timeframe="24">24h</button>
                        <button class="btn btn-outline-secondary" data-timeframe="48">48h</button>
                    </div>
                </div>
                <canvas id="predictions-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Pattern Analysis -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="pattern-card">
                <h4>Market Pattern</h4>
                <div id="pattern-display">
                    <div class="pattern-indicator">Loading...</div>
                </div>
                <div class="mt-3">
                    <h6>Pattern Probabilities</h6>
                    <div id="pattern-probabilities">
                        <!-- Pattern probabilities will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="pattern-card">
                <h4>Risk Analysis</h4>
                <div class="risk-meter">
                    <div class="risk-level" id="risk-level"></div>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Low Risk</span>
                    <span>Medium Risk</span>
                    <span>High Risk</span>
                </div>
                <div class="mt-3">
                    <h6>Risk Score</h6>
                    <div id="risk-score">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="row">
        <div class="col-12">
            <div class="recommendation-card">
                <h4>Trading Recommendations</h4>
                <div class="recommendation-action" id="recommendation-action">
                    Loading...
                </div>
                <div>Confidence Level</div>
                <div class="confidence-meter">
                    <div class="confidence-level" id="confidence-level"></div>
                </div>
                <div class="mt-3" id="recommendation-details">
                    <!-- Recommendation details will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// Chart configuration
const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'top',
        }
    }
};

// Initialize chart
let predictionsChart;

// Format currency
function formatCurrency(num) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(num);
}

// Format percentage
function formatPercent(num) {
    return new Intl.NumberFormat('en-US', {
        style: 'percent',
        minimumFractionDigits: 1,
        maximumFractionDigits: 1
    }).format(num);
}

// Update predictions chart
function updatePredictionsChart(data) {
    const ctx = document.getElementById('predictions-chart').getContext('2d');
    if (predictionsChart) predictionsChart.destroy();
    
    predictionsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: data.predictions.length}, (_, i) => `+${i}h`),
            datasets: [{
                label: 'Price Prediction',
                data: data.predictions,
                borderColor: '#2196f3',
                tension: 0.1
            }]
        },
        options: chartConfig
    });
}

// Update pattern display
function updatePatternDisplay(data) {
    const patternClass = data.pattern.current === 'uptrend' ? 'pattern-uptrend' :
                        data.pattern.current === 'downtrend' ? 'pattern-downtrend' :
                        'pattern-sideways';
    
    document.getElementById('pattern-display').innerHTML = `
        <div class="pattern-indicator ${patternClass}">
            ${data.pattern.current.toUpperCase()}
        </div>
        <div class="mt-2">
            Confidence: ${formatPercent(data.pattern.confidence)}
        </div>
    `;
    
    const probHtml = Object.entries(data.pattern.probabilities)
        .map(([pattern, prob]) => `
            <div class="d-flex justify-content-between mb-1">
                <span>${pattern}</span>
                <span>${formatPercent(prob)}</span>
            </div>
        `)
        .join('');
        
    document.getElementById('pattern-probabilities').innerHTML = probHtml;
}

// Update risk display
function updateRiskDisplay(data) {
    const riskLevel = document.getElementById('risk-level');
    const riskScore = document.getElementById('risk-score');
    
    // Set risk level color and width
    if (data.risk_score <= 0.3) {
        riskLevel.className = 'risk-level risk-low';
        riskLevel.style.width = '33%';
    } else if (data.risk_score <= 0.7) {
        riskLevel.className = 'risk-level risk-medium';
        riskLevel.style.width = '66%';
    } else {
        riskLevel.className = 'risk-level risk-high';
        riskLevel.style.width = '100%';
    }
    
    riskScore.textContent = formatPercent(data.risk_score);
}

// Update recommendations
function updateRecommendations(data) {
    const action = document.getElementById('recommendation-action');
    const confidence = document.getElementById('confidence-level');
    const details = document.getElementById('recommendation-details');
    
    action.textContent = data.recommendations.action.toUpperCase();
    confidence.style.width = `${data.recommendations.confidence * 100}%`;
    
    details.innerHTML = `
        <div class="d-flex justify-content-between mb-2">
            <span>Confidence Level</span>
            <span>${formatPercent(data.recommendations.confidence)}</span>
        </div>
        <div class="d-flex justify-content-between">
            <span>Pattern Strength</span>
            <span>${formatPercent(data.recommendations.pattern_strength)}</span>
        </div>
    `;
}

// Load token options
async function loadTokens() {
    try {
        const response = await fetch('/api/ml/status');
        const data = await response.json();
        
        if (data.success) {
            const tokens = Object.keys(data.data.tokens || {});
            const selector = document.getElementById('token-selector');
            
            tokens.forEach(token => {
                const option = document.createElement('option');
                option.value = token;
                option.textContent = token;
                selector.appendChild(option);
            });
            
            // Load initial data
            if (tokens.length > 0) {
                loadAnalysis(tokens[0]);
            }
        }
        
    } catch (error) {
        console.error('Failed to load tokens:', error);
    }
}

// Load analysis data
async function loadAnalysis(symbol) {
    try {
        const response = await fetch(`/api/ml/analysis/${symbol}`);
        const data = await response.json();
        
        if (data.success) {
            updatePredictionsChart(data.data);
            updatePatternDisplay(data.data);
            updateRiskDisplay(data.data);
            updateRecommendations(data.data);
        }
        
    } catch (error) {
        console.error('Failed to load analysis:', error);
    }
}

// Event listeners
document.getElementById('token-selector').addEventListener('change', function() {
    loadAnalysis(this.value);
});

document.querySelectorAll('[data-timeframe]').forEach(button => {
    button.addEventListener('click', function() {
        const symbol = document.getElementById('token-selector').value;
        const timeframe = this.dataset.timeframe;
        
        // Update active state
        document.querySelectorAll('[data-timeframe]').forEach(b => {
            b.classList.remove('active');
        });
        this.classList.add('active');
        
        // Load predictions with timeframe
        fetch(`/api/ml/predictions/${symbol}?steps=${timeframe}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updatePredictionsChart(data.data);
                }
            })
            .catch(error => {
                console.error('Failed to load predictions:', error);
            });
    });
});

// Load initial data
loadTokens();
</script>
{% endblock %}
