{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block styles %}
<style>
.report-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.report-list {
    max-height: 600px;
    overflow-y: auto;
}

.report-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.report-item:last-child {
    border-bottom: none;
}

.report-info {
    flex-grow: 1;
}

.report-title {
    font-weight: bold;
    margin-bottom: 4px;
}

.report-meta {
    font-size: 12px;
    color: #666;
}

.report-actions {
    display: flex;
    gap: 8px;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Report Generation Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="report-card">
                <h4>Generate Performance Report</h4>
                <form id="performance-form">
                    <div class="mb-3">
                        <label class="form-label">Token</label>
                        <select class="form-select" id="token-selector" required>
                            <!-- Token options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="row">
                            <div class="col">
                                <input type="date" class="form-control" id="start-date" required>
                            </div>
                            <div class="col">
                                <input type="date" class="form-control" id="end-date" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Strategy</label>
                        <select class="form-select" id="strategy-selector" required>
                            <option value="current">Current Strategy</option>
                            <option value="optimized">Optimized Strategy</option>
                            <option value="conservative">Conservative Strategy</option>
                            <option value="aggressive">Aggressive Strategy</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Report</button>
                </form>
            </div>
        </div>
        <div class="col-md-6">
            <div class="report-card">
                <h4>Generate Strategy Comparison</h4>
                <form id="comparison-form">
                    <div class="mb-3">
                        <label class="form-label">Token</label>
                        <select class="form-select" id="comparison-token-selector" required>
                            <!-- Token options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="row">
                            <div class="col">
                                <input type="date" class="form-control" id="comparison-start-date" required>
                            </div>
                            <div class="col">
                                <input type="date" class="form-control" id="comparison-end-date" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Strategies</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="current" id="strategy-current" checked>
                            <label class="form-check-label" for="strategy-current">
                                Current Strategy
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="optimized" id="strategy-optimized">
                            <label class="form-check-label" for="strategy-optimized">
                                Optimized Strategy
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="conservative" id="strategy-conservative">
                            <label class="form-check-label" for="strategy-conservative">
                                Conservative Strategy
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="aggressive" id="strategy-aggressive">
                            <label class="form-check-label" for="strategy-aggressive">
                                Aggressive Strategy
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Comparison</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Reports List -->
    <div class="row">
        <div class="col-12">
            <div class="report-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Generated Reports</h4>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="report-type-filter">
                            <option value="all">All Reports</option>
                            <option value="performance">Performance Reports</option>
                            <option value="comparison">Comparison Reports</option>
                        </select>
                        <button class="btn btn-outline-primary" onclick="refreshReports()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="report-list" id="report-list">
                    <!-- Report items will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show loading overlay
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

// Hide loading overlay
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// Format date
function formatDate(dateString) {
    return new Date(dateString).toLocaleString();
}

// Load tokens
async function loadTokens() {
    try {
        const response = await fetch('/api/ml/status');
        const data = await response.json();
        
        if (data.success) {
            const tokens = Object.keys(data.data.tokens || {});
            const selectors = [
                document.getElementById('token-selector'),
                document.getElementById('comparison-token-selector')
            ];
            
            selectors.forEach(selector => {
                selector.innerHTML = '';
                tokens.forEach(token => {
                    const option = document.createElement('option');
                    option.value = token;
                    option.textContent = token;
                    selector.appendChild(option);
                });
            });
        }
        
    } catch (error) {
        console.error('Failed to load tokens:', error);
    }
}

// Generate performance report
async function generatePerformanceReport(event) {
    event.preventDefault();
    showLoading();
    
    try {
        const formData = {
            symbol: document.getElementById('token-selector').value,
            start_date: document.getElementById('start-date').value,
            end_date: document.getElementById('end-date').value,
            strategy_name: document.getElementById('strategy-selector').value
        };
        
        const response = await fetch('/api/reporting/performance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `performance_${formData.symbol}_${new Date().toISOString()}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Refresh reports list
            refreshReports();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to generate report');
        }
        
    } catch (error) {
        console.error('Failed to generate performance report:', error);
        alert(error.message);
    } finally {
        hideLoading();
    }
}

// Generate comparison report
async function generateComparisonReport(event) {
    event.preventDefault();
    showLoading();
    
    try {
        // Get selected strategies
        const strategies = {};
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            strategies[checkbox.value] = [];  // Will be populated from historical data
        });
        
        if (Object.keys(strategies).length === 0) {
            throw new Error('Please select at least one strategy');
        }
        
        const formData = {
            symbol: document.getElementById('comparison-token-selector').value,
            start_date: document.getElementById('comparison-start-date').value,
            end_date: document.getElementById('comparison-end-date').value,
            strategies: strategies
        };
        
        const response = await fetch('/api/reporting/comparison', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comparison_${formData.symbol}_${new Date().toISOString()}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Refresh reports list
            refreshReports();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to generate report');
        }
        
    } catch (error) {
        console.error('Failed to generate comparison report:', error);
        alert(error.message);
    } finally {
        hideLoading();
    }
}

// Download report
async function downloadReport(path) {
    try {
        const response = await fetch(`/api/reporting/download/${path}`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = path.split('/').pop();
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to download report');
        }
        
    } catch (error) {
        console.error('Failed to download report:', error);
        alert(error.message);
    }
}

// Delete report
async function deleteReport(path) {
    if (!confirm('Are you sure you want to delete this report?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/reporting/delete/${path}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            refreshReports();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete report');
        }
        
    } catch (error) {
        console.error('Failed to delete report:', error);
        alert(error.message);
    }
}

// Refresh reports list
async function refreshReports() {
    try {
        const token = document.getElementById('token-selector').value;
        const type = document.getElementById('report-type-filter').value;
        
        const response = await fetch(`/api/reporting/reports/${token}`);
        const data = await response.json();
        
        if (data.success) {
            const list = document.getElementById('report-list');
            list.innerHTML = '';
            
            data.data
                .filter(report => type === 'all' || report.type === type)
                .forEach(report => {
                    const item = document.createElement('div');
                    item.className = 'report-item';
                    item.innerHTML = `
                        <div class="report-info">
                            <div class="report-title">${report.name}</div>
                            <div class="report-meta">
                                Generated: ${formatDate(report.timestamp)}
                                | Type: ${report.type}
                            </div>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn-sm btn-primary" onclick="downloadReport('${report.path}')">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteReport('${report.path}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(item);
                });
        }
        
    } catch (error) {
        console.error('Failed to refresh reports:', error);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadTokens();
    document.getElementById('performance-form').addEventListener('submit', generatePerformanceReport);
    document.getElementById('comparison-form').addEventListener('submit', generateComparisonReport);
    document.getElementById('token-selector').addEventListener('change', refreshReports);
    document.getElementById('report-type-filter').addEventListener('change', refreshReports);
    refreshReports();
});
</script>
{% endblock %}
