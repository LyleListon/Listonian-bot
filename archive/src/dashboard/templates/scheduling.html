{% extends "base.html" %}

{% block title %}Report Scheduling{% endblock %}

{% block styles %}
<style>
.schedule-card {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.schedule-list {
    max-height: 600px;
    overflow-y: auto;
}

.schedule-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.schedule-item:last-child {
    border-bottom: none;
}

.schedule-info {
    flex-grow: 1;
}

.schedule-title {
    font-weight: bold;
    margin-bottom: 4px;
}

.schedule-meta {
    font-size: 12px;
    color: #666;
}

.schedule-actions {
    display: flex;
    gap: 8px;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Schedule Creation Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="schedule-card">
                <h4>Create Performance Report Schedule</h4>
                <form id="performance-form">
                    <div class="mb-3">
                        <label class="form-label">Token</label>
                        <select class="form-select" id="token-selector" required>
                            <!-- Token options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Strategy</label>
                        <select class="form-select" id="strategy-selector" required>
                            <option value="current">Current Strategy</option>
                            <option value="optimized">Optimized Strategy</option>
                            <option value="conservative">Conservative Strategy</option>
                            <option value="aggressive">Aggressive Strategy</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Schedule Type</label>
                        <select class="form-select" id="schedule-type" required>
                            <option value="interval">Interval</option>
                            <option value="cron">Cron Expression</option>
                        </select>
                    </div>
                    <div class="mb-3" id="interval-section">
                        <label class="form-label">Interval</label>
                        <select class="form-select" id="interval-selector">
                            <!-- Interval options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3" id="cron-section" style="display: none;">
                        <label class="form-label">Cron Expression</label>
                        <select class="form-select" id="cron-selector">
                            <!-- Cron presets will be inserted here -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Schedule</button>
                </form>
            </div>
        </div>
        <div class="col-md-6">
            <div class="schedule-card">
                <h4>Create Strategy Comparison Schedule</h4>
                <form id="comparison-form">
                    <div class="mb-3">
                        <label class="form-label">Token</label>
                        <select class="form-select" id="comparison-token-selector" required>
                            <!-- Token options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Strategies</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="current" id="strategy-current" checked>
                            <label class="form-check-label" for="strategy-current">
                                Current Strategy
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="optimized" id="strategy-optimized">
                            <label class="form-check-label" for="strategy-optimized">
                                Optimized Strategy
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="conservative" id="strategy-conservative">
                            <label class="form-check-label" for="strategy-conservative">
                                Conservative Strategy
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="aggressive" id="strategy-aggressive">
                            <label class="form-check-label" for="strategy-aggressive">
                                Aggressive Strategy
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Schedule Type</label>
                        <select class="form-select" id="comparison-schedule-type" required>
                            <option value="interval">Interval</option>
                            <option value="cron">Cron Expression</option>
                        </select>
                    </div>
                    <div class="mb-3" id="comparison-interval-section">
                        <label class="form-label">Interval</label>
                        <select class="form-select" id="comparison-interval-selector">
                            <!-- Interval options will be inserted here -->
                        </select>
                    </div>
                    <div class="mb-3" id="comparison-cron-section" style="display: none;">
                        <label class="form-label">Cron Expression</label>
                        <select class="form-select" id="comparison-cron-selector">
                            <!-- Cron presets will be inserted here -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Schedule</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Schedules List -->
    <div class="row">
        <div class="col-12">
            <div class="schedule-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Active Schedules</h4>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="schedule-type-filter">
                            <option value="all">All Schedules</option>
                            <option value="performance">Performance Reports</option>
                            <option value="comparison">Comparison Reports</option>
                        </select>
                        <button class="btn btn-outline-primary" onclick="refreshSchedules()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="schedule-list" id="schedule-list">
                    <!-- Schedule items will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show loading overlay
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

// Hide loading overlay
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// Format schedule value
function formatSchedule(type, value) {
    if (type === 'interval') {
        const intervals = {
            '15m': 'Every 15 minutes',
            '30m': 'Every 30 minutes',
            '1h': 'Every hour',
            '4h': 'Every 4 hours',
            '12h': 'Every 12 hours',
            '1d': 'Every day'
        };
        return intervals[value] || value;
    } else {
        const cron_presets = {
            '0 9 * * 1-5': 'Every weekday at 9 AM',
            '0 17 * * 1-5': 'Every weekday at 5 PM',
            '0 0 * * *': 'Every day at midnight',
            '0 0 * * 0': 'Every Sunday at midnight',
            '0 0 1 * *': 'First day of every month'
        };
        return cron_presets[value] || value;
    }
}

// Load tokens
async function loadTokens() {
    try {
        const response = await fetch('/api/ml/status');
        const data = await response.json();
        
        if (data.success) {
            const tokens = Object.keys(data.data.tokens || {});
            const selectors = [
                document.getElementById('token-selector'),
                document.getElementById('comparison-token-selector')
            ];
            
            selectors.forEach(selector => {
                selector.innerHTML = '';
                tokens.forEach(token => {
                    const option = document.createElement('option');
                    option.value = token;
                    option.textContent = token;
                    selector.appendChild(option);
                });
            });
        }
        
    } catch (error) {
        console.error('Failed to load tokens:', error);
    }
}

// Load schedule defaults
async function loadDefaults() {
    try {
        const response = await fetch('/api/scheduling/defaults');
        const data = await response.json();
        
        if (data.success) {
            const intervals = data.data.intervals;
            const cron_presets = data.data.cron_presets;
            
            // Load intervals
            const intervalSelectors = [
                document.getElementById('interval-selector'),
                document.getElementById('comparison-interval-selector')
            ];
            
            intervalSelectors.forEach(selector => {
                selector.innerHTML = '';
                intervals.forEach(interval => {
                    const option = document.createElement('option');
                    option.value = interval.value;
                    option.textContent = interval.label;
                    selector.appendChild(option);
                });
            });
            
            // Load cron presets
            const cronSelectors = [
                document.getElementById('cron-selector'),
                document.getElementById('comparison-cron-selector')
            ];
            
            cronSelectors.forEach(selector => {
                selector.innerHTML = '';
                cron_presets.forEach(preset => {
                    const option = document.createElement('option');
                    option.value = preset.value;
                    option.textContent = preset.label;
                    selector.appendChild(option);
                });
            });
        }
        
    } catch (error) {
        console.error('Failed to load defaults:', error);
    }
}

// Toggle schedule type sections
function toggleScheduleType(prefix = '') {
    const type = document.getElementById(prefix + 'schedule-type').value;
    document.getElementById(prefix + 'interval-section').style.display = 
        type === 'interval' ? 'block' : 'none';
    document.getElementById(prefix + 'cron-section').style.display = 
        type === 'cron' ? 'block' : 'none';
}

// Create performance schedule
async function createPerformanceSchedule(event) {
    event.preventDefault();
    showLoading();
    
    try {
        const type = document.getElementById('schedule-type').value;
        const formData = {
            report_type: 'performance',
            symbol: document.getElementById('token-selector').value,
            schedule_type: type,
            schedule_value: type === 'interval' 
                ? document.getElementById('interval-selector').value
                : document.getElementById('cron-selector').value,
            parameters: {
                strategy_name: document.getElementById('strategy-selector').value
            }
        };
        
        const response = await fetch('/api/scheduling/schedules', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            refreshSchedules();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create schedule');
        }
        
    } catch (error) {
        console.error('Failed to create performance schedule:', error);
        alert(error.message);
    } finally {
        hideLoading();
    }
}

// Create comparison schedule
async function createComparisonSchedule(event) {
    event.preventDefault();
    showLoading();
    
    try {
        // Get selected strategies
        const strategies = {};
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            strategies[checkbox.value] = [];  // Will be populated from historical data
        });
        
        if (Object.keys(strategies).length === 0) {
            throw new Error('Please select at least one strategy');
        }
        
        const type = document.getElementById('comparison-schedule-type').value;
        const formData = {
            report_type: 'comparison',
            symbol: document.getElementById('comparison-token-selector').value,
            schedule_type: type,
            schedule_value: type === 'interval'
                ? document.getElementById('comparison-interval-selector').value
                : document.getElementById('comparison-cron-selector').value,
            parameters: {
                strategies: strategies
            }
        };
        
        const response = await fetch('/api/scheduling/schedules', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            refreshSchedules();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create schedule');
        }
        
    } catch (error) {
        console.error('Failed to create comparison schedule:', error);
        alert(error.message);
    } finally {
        hideLoading();
    }
}

// Toggle schedule
async function toggleSchedule(reportId, enabled) {
    try {
        const response = await fetch(`/api/scheduling/schedules/${reportId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                enabled: enabled
            })
        });
        
        if (response.ok) {
            refreshSchedules();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update schedule');
        }
        
    } catch (error) {
        console.error('Failed to toggle schedule:', error);
        alert(error.message);
    }
}

// Delete schedule
async function deleteSchedule(reportId) {
    if (!confirm('Are you sure you want to delete this schedule?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/scheduling/schedules/${reportId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            refreshSchedules();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete schedule');
        }
        
    } catch (error) {
        console.error('Failed to delete schedule:', error);
        alert(error.message);
    }
}

// Refresh schedules list
async function refreshSchedules() {
    try {
        const type = document.getElementById('schedule-type-filter').value;
        
        const response = await fetch('/api/scheduling/schedules' + 
            (type !== 'all' ? `?report_type=${type}` : ''));
        const data = await response.json();
        
        if (data.success) {
            const list = document.getElementById('schedule-list');
            list.innerHTML = '';
            
            data.data.forEach(schedule => {
                const item = document.createElement('div');
                item.className = 'schedule-item';
                item.innerHTML = `
                    <div class="schedule-info">
                        <div class="schedule-title">
                            ${schedule.report_type === 'performance' ? 'Performance Report' : 'Strategy Comparison'}
                            - ${schedule.symbol}
                        </div>
                        <div class="schedule-meta">
                            Schedule: ${formatSchedule(schedule.schedule_type, schedule.schedule_value)}
                            | Status: ${schedule.enabled ? 'Active' : 'Paused'}
                        </div>
                    </div>
                    <div class="schedule-actions">
                        <button class="btn btn-sm ${schedule.enabled ? 'btn-warning' : 'btn-success'}"
                                onclick="toggleSchedule('${schedule.report_id}', ${!schedule.enabled})">
                            <i class="fas fa-${schedule.enabled ? 'pause' : 'play'}"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSchedule('${schedule.report_id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
    } catch (error) {
        console.error('Failed to refresh schedules:', error);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadTokens();
    loadDefaults();
    document.getElementById('performance-form').addEventListener('submit', createPerformanceSchedule);
    document.getElementById('comparison-form').addEventListener('submit', createComparisonSchedule);
    document.getElementById('schedule-type').addEventListener('change', () => toggleScheduleType());
    document.getElementById('comparison-schedule-type').addEventListener('change', () => toggleScheduleType('comparison-'));
    document.getElementById('schedule-type-filter').addEventListener('change', refreshSchedules);
    refreshSchedules();
});
</script>
{% endblock %}
