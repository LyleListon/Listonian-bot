<!DOCTYPE html>
<html>
<head>
    <title>Arbitrage Monitor Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script>
        // WebSocket connection
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 1000; // Start with 1 second delay

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                // Subscribe to all metric types
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    topics: ['arbitrage', 'flash_loan', 'mev_protection', 'gas', 'profit']
                }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(() => {
                        reconnectAttempts++;
                        console.log(`Reconnecting... Attempt ${reconnectAttempts}`);
                        connectWebSocket();
                    }, reconnectDelay * Math.pow(2, reconnectAttempts - 1));
                } else {
                    console.error('Max reconnection attempts reached');
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketMessage(data) {
            if (data.type === 'metrics') {
                updateMetrics(data.data);
            } else if (data.type === 'alert') {
                showAlert(data.message, data.severity);
            }
        }

        function updateMetrics(metrics) {
            // Update profit metrics
            if (metrics.profit) {
                updateMetricValue('total-profit', metrics.profit.total_profit, 'ETH');
                updateMetricValue('average-profit', metrics.profit.average_profit, 'ETH');
                updateMetricValue('profit-after-gas', metrics.profit.profit_after_gas, 'ETH');
                updateMetricValue('profit-margin', metrics.profit.profit_margin, '%');
                updateChart('profit-chart', metrics.profit.chart_data);
            }

            // Update arbitrage metrics
            if (metrics.arbitrage) {
                updateMetricValue('paths-found', metrics.arbitrage.paths_found);
                updateMetricValue('paths-executed', metrics.arbitrage.paths_executed);
                updateMetricValue('success-rate', metrics.arbitrage.success_rate, '%');
                updateMetricValue('avg-execution-time', metrics.arbitrage.avg_execution_time, 'ms');
                updateChart('arbitrage-chart', metrics.arbitrage.chart_data);
            }

            // Update flash loan metrics
            if (metrics.flash_loan) {
                updateMetricValue('loans-executed', metrics.flash_loan.loans_executed);
                updateMetricValue('loan-success-rate', metrics.flash_loan.success_rate, '%');
                updateMetricValue('average-loan-cost', metrics.flash_loan.average_cost, 'ETH');
                updateMetricValue('total-volume', metrics.flash_loan.total_volume, 'ETH');
                updateChart('flash-loan-chart', metrics.flash_loan.chart_data);
            }

            // Update MEV protection metrics
            if (metrics.mev_protection) {
                updateMetricValue('attacks-detected', metrics.mev_protection.attacks_detected);
                updateMetricValue('bundles-submitted', metrics.mev_protection.bundles_submitted);
                updateMetricValue('bundle-success-rate', metrics.mev_protection.bundle_success_rate, '%');
                updateMetricValue('risk-level', metrics.mev_protection.risk_level);
                updateChart('mev-protection-chart', metrics.mev_protection.chart_data);
            }

            // Update gas metrics
            if (metrics.gas) {
                updateMetricValue('average-gas-price', metrics.gas.average_gas_price, 'GWEI');
                updateMetricValue('average-gas-used', metrics.gas.average_gas_used);
                updateMetricValue('total-gas-cost', metrics.gas.total_gas_cost, 'ETH');
                updateMetricValue('tx-count', metrics.gas.tx_count);
                updateChart('gas-chart', metrics.gas.chart_data);
            }

            // Update last update time
            document.getElementById('last-update').textContent = new Date().toLocaleString();
        }

        function updateMetricValue(elementId, value, unit = '') {
            const element = document.getElementById(elementId);
            if (element) {
                if (typeof value === 'number') {
                    // Format number to 4 decimal places if it's a float
                    value = Number.isInteger(value) ? value : value.toFixed(4);
                }
                element.textContent = unit ? `${value} ${unit}` : value;
                
                // Add animation class
                element.classList.add('value-updated');
                setTimeout(() => {
                    element.classList.remove('value-updated');
                }, 1000);
            }
        }

        function updateChart(elementId, chartData) {
            const chartElement = document.getElementById(elementId);
            if (chartElement && chartData) {
                // Update chart using chart library (e.g., Chart.js)
                // Implementation depends on the charting library being used
            }
        }

        function showAlert(message, severity) {
            const alertsContainer = document.getElementById('alerts-container');
            if (alertsContainer) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${severity}`;
                alert.textContent = message;
                
                alertsContainer.appendChild(alert);
                
                // Remove alert after 5 seconds
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }

        // Initialize WebSocket connection when page loads
        window.addEventListener('load', connectWebSocket);

        // Reconnect WebSocket when page becomes visible
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && (!ws || ws.readyState !== WebSocket.OPEN)) {
                connectWebSocket();
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Arbitrage Monitoring Dashboard</h1>
            <p>Last updated: <span id="last-update">Never</span></p>
        </div>

        <!-- Alerts Container -->
        <div id="alerts-container" class="alerts-container"></div>

        <!-- System Status -->
        <div class="card system-status">
            <h2>System Status</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-label">Connection Status</div>
                    <div id="connection-status" class="metric-value">Connecting...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Block Height</div>
                    <div id="block-height" class="metric-value">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Network</div>
                    <div id="network" class="metric-value">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Uptime</div>
                    <div id="uptime" class="metric-value">-</div>
                </div>
            </div>
        </div>

        <!-- Profit Section -->
        <div class="card">
            <h2>Profit Metrics</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Profit</div>
                    <div id="total-profit" class="metric-value good">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Profit</div>
                    <div id="average-profit" class="metric-value good">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Profit After Gas</div>
                    <div id="profit-after-gas" class="metric-value good">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Profit Margin</div>
                    <div id="profit-margin" class="metric-value good">-</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="profit-chart"></canvas>
            </div>
        </div>

        <!-- Arbitrage Section -->
        <div class="card">
            <h2>Arbitrage Performance</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-label">Paths Found</div>
                    <div id="paths-found" class="metric-value info">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Paths Executed</div>
                    <div id="paths-executed" class="metric-value info">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Success Rate</div>
                    <div id="success-rate" class="metric-value info">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Execution Time</div>
                    <div id="avg-execution-time" class="metric-value info">-</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="arbitrage-chart"></canvas>
            </div>
        </div>

        <!-- Flash Loan Section -->
        <div class="card">
            <h2>Flash Loan Performance</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-label">Loans Executed</div>
                    <div id="loans-executed" class="metric-value info">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Success Rate</div>
                    <div id="loan-success-rate" class="metric-value info">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Cost</div>
                    <div id="average-loan-cost" class="metric-value info">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Volume</div>
                    <div id="total-volume" class="metric-value info">-</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="flash-loan-chart"></canvas>
            </div>
        </div>

        <!-- MEV Protection Section -->
        <div class="card">
            <h2>MEV Protection Performance</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-label">Attacks Detected</div>
                    <div id="attacks-detected" class="metric-value warning">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Bundles Submitted</div>
                    <div id="bundles-submitted" class="metric-value info">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Bundle Success Rate</div>
                    <div id="bundle-success-rate" class="metric-value info">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Risk Level</div>
                    <div id="risk-level" class="metric-value warning">-</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="mev-protection-chart"></canvas>
            </div>
        </div>

        <!-- Gas Section -->
        <div class="card">
            <h2>Gas Metrics</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-label">Average Gas Price</div>
                    <div id="average-gas-price" class="metric-value warning">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Gas Used</div>
                    <div id="average-gas-used" class="metric-value info">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Gas Cost</div>
                    <div id="total-gas-cost" class="metric-value warning">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Transactions Count</div>
                    <div id="tx-count" class="metric-value info">-</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="gas-chart"></canvas>
            </div>
        </div>

        <footer>
            <p>Arbitrage Monitoring Dashboard | Real-time Updates</p>
        </footer>
    </div>
</body>
</html>