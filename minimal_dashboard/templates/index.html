<!DOCTYPE html>
<html>
<head>
    <title>Arbitrage Bot Dashboard</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>Arbitrage Bot Dashboard</h1>
    
    <div class="data-section" id="market-section">
        <h2>Market Data</h2>
        <div id="dex-status">Loading DEX status...</div>
        <div id="market-data">Loading...</div>
        <div class="legend">
            Each opportunity shows:<br>
            • Token Pair: The tokens being traded (e.g., ETH/USDC)<br>
            • DEX Route: Buy on first DEX, sell on second DEX<br>
            • Trade Size: Amount of the trade<br>
            • Gross Profit: Profit before gas fees<br>
            • Net Profit: <strong>Actual profit after gas fees</strong> (must be ≥$0.05)<br>
            • Price Difference: Percentage difference between DEXes<br>
            • Liquidity: Available liquidity for the trade<br>
            • Status: profitable/monitoring/executing<br>
            • Time: When opportunity was found
        </div>
        <div class="trade-history">
            <h3>Recent Trades</h3>
            <div id="trade-history">No trades yet</div>
        </div>
    </div>

    <div class="data-section" id="memory-section">
        <h2>Memory Stats</h2>
        <div id="memory-data">Loading...</div>
    </div>

    <div class="data-section" id="gas-section">
        <h2>Gas Prices & Usage</h2>
        <div id="gas-data">Loading...</div>
    </div>

    <script>
        const socket = io({
            path: '/socket.io',
            transports: ['polling', 'websocket'],
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000,
            autoConnect: true,
            forceNew: true
        });

        const tradeHistory = [];

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            // Show error in UI
            document.querySelectorAll('[id$="-data"]').forEach(el => {
                el.innerHTML = `<div class="error">Connection error: ${error.message}</div>`;
            });
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            // Try to reconnect after 5 seconds
            setTimeout(() => socket.connect(), 5000);
        });

        function showUpdateAnimation(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.add('updated');
            setTimeout(() => {
                section.classList.remove('updated');
            }, 300);
        }

        socket.on('trade_result', (result) => {
            tradeHistory.unshift(result);
            if (tradeHistory.length > 10) tradeHistory.pop();
            
            const historyDiv = document.getElementById('trade-history');
            if (tradeHistory.length > 0) {
                let html = '';
                tradeHistory.forEach(trade => {
                    html += `
                        <div class="trade-history-item">
                            <span>${trade.pair} (${trade.dex})</span>
                            <span class="${trade.success ? 'profit' : 'failed'}">${trade.success ? trade.profit : 'Failed'}</span>
                            <span class="trade-time">${trade.timestamp}</span>
                        </div>`;
                });
                historyDiv.innerHTML = html;
            } else {
                historyDiv.innerHTML = 'No trades yet';
            }
        });

        socket.on('market_update', (data) => {
            const marketDiv = document.getElementById('market-data');
            const dexStatusDiv = document.getElementById('dex-status');
            
            if (data.error) {
                marketDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                return;
            }
            
            // Update DEX status
            if (data.dex_status) {
                let statusHtml = '<div class="dex-status-grid">';
                for (const [dex, status] of Object.entries(data.dex_status)) {
                    statusHtml += `
                        <div class="dex-status-item ${status}">
                            <span class="dex-name">${dex}</span>
                            <span class="dex-indicator"></span>
                        </div>`;
                }
                statusHtml += '</div>';
                dexStatusDiv.innerHTML = statusHtml;
            }
            
            let html = `<h3>Current Opportunities <span class="gas-note">(Gas Cost: ${data.gas_cost})</span></h3>`;
            if (data.opportunities && data.opportunities.length > 0) {
                html += '<ul style="list-style: none; padding: 0;">';
                data.opportunities.forEach(opp => {
                    html += `
                        <li class="opportunity">
                            <div class="opportunity-details">
                                <div class="opportunity-main">
                                    <div class="token-pair">${opp.pair}</div>
                                    <div class="dex-route">${opp.dex}</div>
                                    <div class="trade-size">Trade: ${opp.size}</div>
                                </div>
                                <div class="opportunity-profits">
                                    <div class="gross-profit">Gross: ${opp.gross_profit}</div>
                                    <div class="net-profit">Net: ${opp.net_profit}</div>
                                    <div class="price-diff">Diff: ${opp.price_diff}</div>
                                </div>
                                <div class="opportunity-details">
                                    <div class="liquidity">Liquidity: ${opp.liquidity}</div>
                                    <div class="status ${opp.status}">${opp.status}</div>
                                    <div class="timestamp">${opp.timestamp}</div>
                                </div>
                            </div>
                        </li>`;
                });
                html += '</ul>';
            } else {
                html += '<div class="no-opportunities">No profitable opportunities (after gas)</div>';
            }
            marketDiv.innerHTML = html;
            showUpdateAnimation('market-section');
        });

        socket.on('memory_update', (data) => {
            const memoryDiv = document.getElementById('memory-data');
            if (data.error) {
                memoryDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                return;
            }
            
            memoryDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">Cache Size<br><strong>${data.cache_size} items</strong></div>
                    <div class="stat-item">Hit Rate<br><strong>${data.hit_rate}%</strong></div>
                    <div class="stat-item">Last Update<br><strong>${new Date(data.last_update * 1000).toLocaleTimeString()}</strong></div>
                </div>`;
            showUpdateAnimation('memory-section');
        });

        socket.on('gas_update', (data) => {
            const gasDiv = document.getElementById('gas-data');
            if (data.error) {
                gasDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                return;
            }
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-item">Current Gas<br><strong>${data.current_gas_price} gwei</strong></div>
                    <div class="stat-item">Base Fee<br><strong>${data.base_fee} gwei</strong></div>
                    <div class="stat-item">Max Priority Fee<br><strong>${data.max_priority_fee} gwei</strong></div>
                    <div class="stat-item">Max Fee<br><strong>${data.max_fee} gwei</strong></div>
                    <div class="stat-item">Next Est. Cost<br><strong>${data.estimated_next_cost}</strong></div>
                </div>`;

            if (data.monthly_stats) {
                html += `
                    <div class="gas-stats">
                        <h3>Monthly Gas Usage</h3>
                        <div class="gas-stats-grid">
                            <div class="gas-stat-item">
                                <div class="label">Total Gas Used</div>
                                <div class="value">${data.monthly_stats.total_gas_used.toLocaleString()}</div>
                            </div>
                            <div class="gas-stat-item">
                                <div class="label">Total Cost</div>
                                <div class="value">${data.monthly_stats.total_gas_cost}</div>
                            </div>
                            <div class="gas-stat-item">
                                <div class="label">Average Gas Price</div>
                                <div class="value">${data.monthly_stats.average_gas_price}</div>
                            </div>
                        </div>
                        <div class="gas-stats-grid">
                            <div class="gas-stat-item">
                                <div class="label">Highest Gas Price</div>
                                <div class="value">${data.monthly_stats.highest_gas_price}</div>
                            </div>
                            <div class="gas-stat-item">
                                <div class="label">Lowest Gas Price</div>
                                <div class="value">${data.monthly_stats.lowest_gas_price}</div>
                            </div>
                        </div>
                        <div class="gas-transfers">
                            <div class="gas-transfer-item">
                                <div class="label">Transfers to Recipient</div>
                                <div class="value">${data.monthly_stats.transfers_to_recipient}</div>
                            </div>
                            <div class="gas-transfer-item">
                                <div class="label">Kept in Wallet</div>
                                <div class="value">${data.monthly_stats.kept_in_wallet}</div>
                            </div>
                        </div>
                    </div>`;
            }
            
            gasDiv.innerHTML = html;
            showUpdateAnimation('gas-section');
        });
    </script>
</body>
</html>