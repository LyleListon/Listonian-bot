{% extends "base.html" %}

{% block title %}Dashboard - Arbitrage Bot{% endblock %}

{% block extra_css %}
<style>
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Overview Section -->
<div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Dashboard Overview</h1>
    
    <!-- Key Metrics Grid -->
    <div class="metric-grid">
        <!-- Profit Metrics -->
        <div class="dashboard-card">
            <div class="card-header">
                <h2 class="card-title">Total Profit</h2>
                <span class="text-sm text-gray-500 dark:text-gray-400">24h</span>
            </div>
            <div id="totalProfit" class="card-value">Loading...</div>
            <div id="profitChange" class="card-subtitle mt-2">
                <span class="metric-neutral">Calculating...</span>
            </div>
        </div>

        <!-- Gas Metrics -->
        <div class="dashboard-card">
            <div class="card-header">
                <h2 class="card-title">Current Gas Price</h2>
                <span class="text-sm text-gray-500 dark:text-gray-400">GWEI</span>
            </div>
            <div id="gasPrice" class="card-value">Loading...</div>
            <div id="gasTrend" class="card-subtitle mt-2">
                <span class="metric-neutral">Monitoring...</span>
            </div>
        </div>

        <!-- Opportunity Metrics -->
        <div class="dashboard-card">
            <div class="card-header">
                <h2 class="card-title">Active Opportunities</h2>
                <span class="text-sm text-gray-500 dark:text-gray-400">Last 5m</span>
            </div>
            <div id="opportunityCount" class="card-value">Loading...</div>
            <div id="opportunityTrend" class="card-subtitle mt-2">
                <span class="metric-neutral">Analyzing...</span>
            </div>
        </div>

        <!-- Success Rate -->
        <div class="dashboard-card">
            <div class="card-header">
                <h2 class="card-title">Success Rate</h2>
                <span class="text-sm text-gray-500 dark:text-gray-400">24h</span>
            </div>
            <div id="successRate" class="card-value">Loading...</div>
            <div id="successTrend" class="card-subtitle mt-2">
                <span class="metric-neutral">Calculating...</span>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Profit Chart -->
    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">Profit History</h2>
            <select id="profitTimeRange" class="form-select w-32">
                <option value="1h">Last Hour</option>
                <option value="24h" selected>24 Hours</option>
                <option value="7d">7 Days</option>
                <option value="30d">30 Days</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="profitChart"></canvas>
        </div>
    </div>

    <!-- Gas Price Chart -->
    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">Gas Price Trends</h2>
            <select id="gasTimeRange" class="form-select w-32">
                <option value="1h">Last Hour</option>
                <option value="24h" selected>24 Hours</option>
                <option value="7d">7 Days</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="gasChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">Recent Activity</h2>
        <button id="refreshActivity" class="btn btn-secondary">Refresh</button>
    </div>
    <div class="overflow-x-auto">
        <table class="data-table">
            <thead class="table-header">
                <tr>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Details</th>
                    <th>Profit</th>
                    <th>Gas Cost</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="activityTable" class="table-body">
                <tr>
                    <td colspan="6" class="table-cell text-center">Loading activity data...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Chart configurations
    const profitChartConfig = {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Profit',
                data: [],
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => `$${value.toFixed(2)}`
                    }
                }
            }
        }
    };

    const gasChartConfig = {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Gas Price',
                data: [],
                borderColor: '#6366F1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => `${value} GWEI`
                    }
                }
            }
        }
    };

    // Initialize charts
    const profitChart = new Chart(
        document.getElementById('profitChart'),
        profitChartConfig
    );

    const gasChart = new Chart(
        document.getElementById('gasChart'),
        gasChartConfig
    );

    // WebSocket message handler
    document.addEventListener('websocket-message', function(event) {
        const data = event.detail;
        
        switch(data.type) {
            case 'metrics_update':
                updateMetrics(data.data);
                break;
            case 'gas_update':
                updateGasData(data.data);
                break;
            case 'opportunity_update':
                updateOpportunities(data.data);
                break;
        }
    });

    // Update functions
    function updateMetrics(data) {
        // Update profit metrics
        const totalProfit = data.performance.total_profit;
        document.getElementById('totalProfit').textContent = `$${totalProfit.toFixed(2)}`;
        
        const profitChange = data.performance.profit_trend[0]?.profit || 0;
        const profitElement = document.getElementById('profitChange');
        profitElement.innerHTML = `
            <span class="metric-${profitChange >= 0 ? 'up' : 'down'}">
                ${profitChange >= 0 ? '↑' : '↓'} ${Math.abs(profitChange).toFixed(2)}
            </span>
        `;

        // Update success rate
        const successRate = data.performance.success_rate * 100;
        document.getElementById('successRate').textContent = `${successRate.toFixed(1)}%`;
        
        // Update profit chart
        updateProfitChart(data.performance.profit_trend);
    }

    function updateGasData(data) {
        // Update gas price
        document.getElementById('gasPrice').textContent = data.current_price.toFixed(1);
        
        const gasTrend = data.trend[0]?.price || 0;
        const gasTrendElement = document.getElementById('gasTrend');
        gasTrendElement.innerHTML = `
            <span class="metric-${gasTrend >= data.current_price ? 'down' : 'up'}">
                ${gasTrend >= data.current_price ? '↓' : '↑'} ${Math.abs(gasTrend - data.current_price).toFixed(1)}
            </span>
        `;

        // Update gas chart
        updateGasChart(data.trend);
    }

    function updateOpportunities(data) {
        // Update opportunity count
        document.getElementById('opportunityCount').textContent = data.count;
        
        const opportunityTrend = data.count - (data.previous_count || 0);
        const opportunityElement = document.getElementById('opportunityTrend');
        opportunityElement.innerHTML = `
            <span class="metric-${opportunityTrend >= 0 ? 'up' : 'down'}">
                ${opportunityTrend >= 0 ? '↑' : '↓'} ${Math.abs(opportunityTrend)}
            </span>
        `;
    }

    function updateProfitChart(trend) {
        profitChart.data.labels = trend.map(t => moment(t.timestamp).format('HH:mm'));
        profitChart.data.datasets[0].data = trend.map(t => t.profit);
        profitChart.update();
    }

    function updateGasChart(trend) {
        gasChart.data.labels = trend.map(t => moment(t.timestamp).format('HH:mm'));
        gasChart.data.datasets[0].data = trend.map(t => t.price);
        gasChart.update();
    }

    // Time range change handlers
    document.getElementById('profitTimeRange').addEventListener('change', function(e) {
        fetch(`/api/metrics/historical/profits?time_range=${e.target.value}`)
            .then(response => response.json())
            .then(data => updateProfitChart(data.intervals));
    });

    document.getElementById('gasTimeRange').addEventListener('change', function(e) {
        fetch(`/api/metrics/historical/gas?time_range=${e.target.value}`)
            .then(response => response.json())
            .then(data => updateGasChart(data.intervals));
    });

    // Activity refresh handler
    document.getElementById('refreshActivity').addEventListener('click', function() {
        fetch('/api/metrics/current')
            .then(response => response.json())
            .then(data => updateMetrics(data));
    });
</script>
{% endblock %}