<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitrage Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card.updated {
            background-color: rgba(52, 211, 153, 0.1);
        }
        .flash {
            animation: flash 0.5s ease-out;
        }
        @keyframes flash {
            0% { background-color: rgba(52, 211, 153, 0.3); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold">Arbitrage Bot Dashboard</h1>
            <div id="connection-status" class="text-sm text-gray-400 mt-2">
                Connecting...
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Performance Metrics -->
            <div class="metric-card bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Performance</h3>
                <div class="space-y-4">
                    <div>
                        <p class="text-gray-400">Total Profit (ETH)</p>
                        <p id="total-profit" class="text-2xl font-bold text-green-400">0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Success Rate</p>
                        <p id="success-rate" class="text-2xl font-bold text-blue-400">0%</p>
                    </div>
                </div>
            </div>

            <!-- System Metrics -->
            <div class="metric-card bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">System</h3>
                <div class="space-y-4">
                    <div>
                        <p class="text-gray-400">CPU Usage</p>
                        <p id="cpu-usage" class="text-2xl font-bold text-yellow-400">0%</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Memory Usage</p>
                        <p id="memory-usage" class="text-2xl font-bold text-purple-400">0%</p>
                    </div>
                </div>
            </div>

            <!-- Gas Price -->
            <div class="metric-card bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Network</h3>
                <div class="space-y-4">
                    <div>
                        <p class="text-gray-400">Gas Price (Gwei)</p>
                        <p id="gas-price" class="text-2xl font-bold text-red-400">0</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Status</p>
                        <p id="network-status" class="text-2xl font-bold text-blue-400">-</p>
                    </div>
                </div>
            </div>

            <!-- Market Data -->
            <div class="metric-card bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Market Data</h3>
                <div class="space-y-4">
                    <!-- DEX Prices -->
                    <div>
                        <p class="text-gray-400">BaseSwap V3 (WETH)</p>
                        <p id="baseswap-price" class="text-2xl font-bold text-blue-400">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Aerodrome V3 (WETH)</p>
                        <p id="aerodrome-price" class="text-2xl font-bold text-purple-400">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Best Spread</p>
                        <p id="best-spread" class="text-2xl font-bold text-green-400">0.00%</p>
                    </div>
                </div>
            </div>

            <!-- Liquidity Overview -->
            <div class="metric-card bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Liquidity</h3>
                <div class="space-y-4">
                    <div>
                        <p class="text-gray-400">BaseSwap V3 Pool</p>
                        <p id="baseswap-liquidity" class="text-2xl font-bold text-yellow-400">0.00 ETH</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Aerodrome V3 Pool</p>
                        <p id="aerodrome-liquidity" class="text-2xl font-bold text-red-400">0.00 ETH</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Total Locked Value</p>
                        <p id="total-liquidity" class="text-2xl font-bold text-indigo-400">0.00 ETH</p>
                    </div>
                </div>
            </div>

            <!-- Bot Status -->
            <div class="metric-card bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Bot Status</h3>
                <div class="space-y-4">
                    <div>
                        <p class="text-gray-400">State</p>
                        <p id="bot-status" class="text-2xl font-bold text-green-400">-</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Last Update</p>
                        <p id="last-update" class="text-sm text-gray-400">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Profit Trend</h3>
                <canvas id="profit-chart" class="w-full" height="200"></canvas>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Price Comparison</h3>
                <canvas id="price-chart" class="w-full" height="200"></canvas>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Liquidity Depth</h3>
                <canvas id="liquidity-chart" class="w-full" height="200"></canvas>
                <p id="liquidity-update" class="text-sm text-gray-400 mt-2">Last updated: Never</p>
            </div>
        </div>

        <!-- Trade History -->
        <div class="mt-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Recent Trades</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="text-left text-gray-400">
                                <th class="py-2">Time</th>
                                <th class="py-2">Token Pair</th>
                                <th class="py-2">DEX Route</th>
                                <th class="py-2">Profit</th>
                                <th class="py-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="trade-history">
                            <!-- Trade history rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection management
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 1000;
        
        // Charts
        let profitChart = null;
        let systemChart = null;
        
        // Initialize charts
        function initializeCharts() {
            const profitCtx = document.getElementById('profit-chart').getContext('2d');
            const profitChart = new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: Array(24).fill(''),
                    datasets: [{
                        label: 'Profit (ETH)',
                        data: Array(24).fill(0),
                        borderColor: 'rgb(52, 211, 153)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            const priceCtx = document.getElementById('price-chart').getContext('2d');
            const priceChart = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: Array(60).fill(''),
                    datasets: [{
                        label: 'CPU Usage',
                        data: Array(60).fill(0),
                        borderColor: 'rgb(251, 191, 36)',
                        tension: 0.1
                    }, {
                        label: 'Memory Usage',
                        data: Array(60).fill(0),
                        borderColor: 'rgb(167, 139, 250)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            const liquidityCtx = document.getElementById('liquidity-chart').getContext('2d');
            const liquidityChart = new Chart(liquidityCtx, {
                type: 'bar',
                data: {
                    labels: ['BaseSwap V3', 'Aerodrome V3'],
                    datasets: [{
                        label: 'Pool Liquidity (ETH)',
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.5)',
                            'rgba(167, 139, 250, 0.5)'
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(167, 139, 250)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            // Store chart references
            window.charts = { profitChart, priceChart, liquidityChart };
        }

        // Update UI elements
        function updateMetrics(data) {
            // Performance metrics
            if (data.metrics && data.metrics.metrics) {
                document.getElementById('total-profit').textContent = 
                    parseFloat(data.metrics.metrics.total_profit_eth).toFixed(4);
                document.getElementById('success-rate').textContent = 
                    (data.metrics.metrics.success_rate * 100).toFixed(1) + '%';
            }

            // System metrics
            if (data.metrics && data.metrics.system) {
                document.getElementById('cpu-usage').textContent = 
                    data.metrics.system.cpu_usage.toFixed(1) + '%';
                document.getElementById('memory-usage').textContent = 
                    data.metrics.system.memory_usage.toFixed(1) + '%';
            }
            
            // Market data updates
            if (data.market_data) {
                const prices = data.market_data.prices || {};
                const liquidity = data.market_data.liquidity || {};
                const spreads = data.market_data.spreads || {};
                
                // Update price displays
                if (prices.baseswap_v3) {
                    document.getElementById('baseswap-price').textContent = 
                        '$' + prices.baseswap_v3.toFixed(2);
                }
                if (prices.aerodrome_v3) {
                    document.getElementById('aerodrome-price').textContent = 
                        '$' + prices.aerodrome_v3.toFixed(2);
                }
                
                // Update liquidity displays
                if (liquidity.baseswap_v3) {
                    document.getElementById('baseswap-liquidity').textContent = 
                        (liquidity.baseswap_v3 / 1e18).toFixed(2) + ' ETH';
                }
                if (liquidity.aerodrome_v3) {
                    document.getElementById('aerodrome-liquidity').textContent = 
                        (liquidity.aerodrome_v3 / 1e18).toFixed(2) + ' ETH';
                }
                
                // Update total liquidity
                const totalLiquidity = (liquidity.baseswap_v3 || 0) + (liquidity.aerodrome_v3 || 0);
                document.getElementById('total-liquidity').textContent = 
                    (totalLiquidity / 1e18).toFixed(2) + ' ETH';
                
            }

            // Network metrics
            if (data.metrics) {
                document.getElementById('gas-price').textContent = 
                    Math.round(data.metrics.gas_price);
            }
            if (data.system_status) {
                document.getElementById('network-status').textContent = 
                    data.system_status.network_status;
                document.getElementById('bot-status').textContent = 
                    data.system_status.bot_status;
                document.getElementById('last-update').textContent = 
                    new Date(data.system_status.last_update).toLocaleString();
            }

            // Update charts
            if (window.charts) updateCharts(data);

            // Update trade history
            if (data.trade_history) {
                updateTradeHistory(data.trade_history);
            }

            // Flash updated elements
            document.querySelectorAll('.metric-card').forEach(card => {
                card.classList.add('flash');
                setTimeout(() => card.classList.remove('flash'), 500);
            });
        }

        async function updateCharts(data) {
            if (!data.metrics || !data.metrics.metrics) return;

            // Update profit trend
            const profitTrend = data.metrics.metrics.profit_trend;
            if (profitTrend) {
                profitChart.data.labels = profitTrend.map(p => {
                    const date = new Date(p.timestamp);
                    return date.getHours().toString().padStart(2, '0') + ':00';
                });
                profitChart.data.datasets[0].data = profitTrend.map(p => p.profit);
                profitChart.update('none');
            }

            
            // Update price chart
            if (data.market_data && data.market_data.prices) {
                const prices = data.market_data.prices;
                const timestamp = new Date().toLocaleTimeString();
                
                window.charts.priceChart.data.labels.shift();
                window.charts.priceChart.data.labels.push(timestamp);
                
                window.charts.priceChart.data.datasets[0].data.shift();
                window.charts.priceChart.data.datasets[0].data.push(prices.baseswap_v3 || 0);
                
                window.charts.priceChart.data.datasets[1].data.shift();
                window.charts.priceChart.data.datasets[1].data.push(prices.aerodrome_v3 || 0);
                
                window.charts.priceChart.update('none');
            }

            // Update liquidity chart
            if (data.market_data && data.market_data.liquidity) {
                const liquidity = data.market_data.liquidity;
                
                window.charts.liquidityChart.data.datasets[0].data = [
                    (liquidity.baseswap_v3 || 0) / 1e18,
                    (liquidity.aerodrome_v3 || 0) / 1e18
                ];
                
                window.charts.liquidityChart.update('none');
                
                document.getElementById('liquidity-update').textContent = 
                    'Last updated: ' + new Date().toLocaleString();
            }
        }

        function updateTradeHistory(trades) {
            const tbody = document.getElementById('trade-history');
            tbody.innerHTML = trades.map(trade => `
                <tr class="border-t border-gray-700">
                    <td class="py-2">${new Date(trade.timestamp).toLocaleString()}</td>
                    <td class="py-2">${trade.opportunity.token_pair}</td>
                    <td class="py-2">${trade.opportunity.dex_1} → ${trade.opportunity.dex_2}</td>
                    <td class="py-2 ${trade.net_profit >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${parseFloat(trade.net_profit).toFixed(6)} ETH
                    </td>
                    <td class="py-2">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            trade.success ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200'
                        }">
                            ${trade.success ? 'Success' : 'Failed'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // WebSocket connection management
        function connect() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/metrics`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('connection-status').textContent = 'Connected';
                document.getElementById('connection-status').className = 'text-sm text-green-400 mt-2';
                reconnectAttempts = 0;
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateMetrics(data);
                } catch (error) {
                    console.error('Error processing message:', error);
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('connection-status').className = 'text-sm text-red-400 mt-2';
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connect, reconnectDelay * reconnectAttempts);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('connection-status').textContent = 'Connection Error';
                document.getElementById('connection-status').className = 'text-sm text-red-400 mt-2';
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeCharts();
            connect();
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>