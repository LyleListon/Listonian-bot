{% extends "base.html" %}

{% block title %}Dashboard - Arbitrage Bot{% endblock %}

{% block content %}
<div class="grid">
    <!-- Total Profit Card -->
    <div class="dashboard-card">
        <h2>Total Profit</h2>
        <div id="totalProfit">
            <div class="metric-value">Loading...</div>
            <div class="metric-label">24h</div>
        </div>
    </div>

    <!-- Current Gas Price Card -->
    <div class="dashboard-card">
        <h2>Current Gas Price</h2>
        <div id="gasPrice">
            <div class="metric-value">Loading...</div>
            <div class="metric-label">GWEI</div>
        </div>
    </div>

    <!-- Active Opportunities Card -->
    <div class="dashboard-card">
        <h2>Active Opportunities</h2>
        <div id="activeOpportunities">
            <div class="metric-value">Loading...</div>
            <div class="metric-label">Last 5m</div>
        </div>
    </div>

    <!-- Success Rate Card -->
    <div class="dashboard-card">
        <h2>Success Rate</h2>
        <div id="successRate">
            <div class="metric-value">Loading...</div>
            <div class="metric-label">24h</div>
        </div>
    </div>
</div>

<!-- Profit History Chart -->
<div class="dashboard-card">
    <h2>Profit History</h2>
    <div class="chart-container">
        <canvas id="profitChart"></canvas>
    </div>
    <div class="chart-controls">
        <select id="timeRange">
            <option value="24">24 Hours</option>
            <option value="168">7 Days</option>
            <option value="720">30 Days</option>
        </select>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let profitChart = null;

    function initProfitChart() {
        const ctx = document.getElementById('profitChart');
        if (!ctx) {
            console.error('Canvas element not found');
            return;
        }

        profitChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Profit (ETH)',
                    data: [],
                    borderColor: '#4CAF50',
                    tension: 0.4,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Profit (ETH)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function updateProfitChart(data) {
        if (!profitChart) {
            initProfitChart();
        }

        if (!profitChart) {
            console.error('Failed to initialize chart');
            return;
        }

        // Update chart data
        const labels = data.map(d => moment(d.timestamp).format('HH:mm'));
        const values = data.map(d => d.profit);

        profitChart.data.labels = labels;
        profitChart.data.datasets[0].data = values;
        profitChart.update();
    }

    // Handle WebSocket messages
    document.addEventListener('websocket-message', function(e) {
        const data = e.detail;

        if (data.type === 'metrics_update') {
            // Update metrics
            const metrics = data.data.performance;
            document.getElementById('totalProfit').querySelector('.metric-value').textContent = 
                `${metrics.total_profit.toFixed(4)} ETH`;
            document.getElementById('successRate').querySelector('.metric-value').textContent = 
                `${(metrics.success_rate * 100).toFixed(1)}%`;
            
            // Update profit chart
            updateProfitChart(metrics.profit_trend);
        }

        if (data.type === 'memory_update') {
            // Update opportunities
            const opportunities = data.data.opportunities || [];
            document.getElementById('activeOpportunities').querySelector('.metric-value').textContent = 
                opportunities.length.toString();
        }

        if (data.type === 'system_update') {
            // Update gas price
            const gasPrice = data.data.network?.gas_price || 0;
            document.getElementById('gasPrice').querySelector('.metric-value').textContent = 
                `${gasPrice.toFixed(1)}`;
        }
    });

    // Handle time range changes
    document.getElementById('timeRange').addEventListener('change', function(e) {
        const hours = parseInt(e.target.value);
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'update_time_range',
                hours: hours
            }));
        }
    });

    // Initialize chart when page loads
    document.addEventListener('DOMContentLoaded', initProfitChart);
</script>
{% endblock %}