<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitrage Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="sidebar-header text-center mb-4">
                        <h4 class="text-white">Arbitrage Bot</h4>
                        <p class="text-light small">Dashboard v1.0</p>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-house-door me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-graph-up me-2"></i> Performance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-currency-exchange me-2"></i> DEX Status
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-diagram-3 me-2"></i> Arbitrage Paths
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-gear me-2"></i> Settings
                            </a>
                        </li>
                    </ul>

                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>System</span>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-file-text me-2"></i> Logs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-exclamation-triangle me-2"></i> Alerts
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Dashboard</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshData()">
                                <i class="bi bi-arrow-repeat"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleDebug">
                                <i class="bi bi-bug"></i> Debug
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Notifications -->
                {% if error_message %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> <strong>Error:</strong> {{ error_message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                
                {% if info_message %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle-fill me-2"></i> <strong>Info:</strong> {{ info_message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                
                <!-- Debug Information (initially hidden) -->
                <div id="debugPanel" class="card mb-4" style="display: none;">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-bug-fill me-2"></i> Debug Information
                    </div>
                    <div class="card-body">
                        <pre class="mb-0">{{ debug_info }}</pre>
                    </div>
                </div>

                <!-- Status Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-4">
                        <div class="card h-100 border-left-primary shadow">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Status</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="status">{{ status }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-check-circle fs-2 text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4">
                        <div class="card h-100 border-left-success shadow">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Wallet Balance</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="wallet-balance">{{ wallet_balance }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-wallet2 fs-2 text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4">
                        <div class="card h-100 border-left-info shadow">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                            Uptime</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="uptime">{{ uptime }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-clock-history fs-2 text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4">
                        <div class="card h-100 border-left-warning shadow">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                            Total Profit</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-profit">
                                            {% if bot_data.profit_summary.total_profit_eth > 0 %}
                                                {{ "%.4f"|format(bot_data.profit_summary.total_profit_eth) }} ETH
                                            {% else %}
                                                {{ total_profit }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-graph-up-arrow fs-2 text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot Status Panel -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Bot Status</h6>
                                <div class="dropdown no-arrow">
                                    <button class="btn btn-sm btn-light" id="refreshBotStatus">
                                        <i class="bi bi-arrow-repeat"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card mb-3">
                                            <div class="card-header bg-info text-white py-2">
                                                <h6 class="m-0">Bot Activity</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-borderless table-sm">
                                                        <tbody>
                                                            <tr>
                                                                <td><strong>Status</strong></td>
                                                                <td>
                                                                    <span class="badge {% if bot_data.bot_status.status == 'Healthy' %}bg-success{% elif bot_data.bot_status.status == 'Warning' %}bg-warning{% elif bot_data.bot_status.status == 'Error' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                                        {{ bot_data.bot_status.status }}
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Last Activity</strong></td>
                                                                <td>{{ bot_data.bot_status.last_activity }}</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Opportunities (24h)</strong></td>
                                                                <td>{{ bot_data.bot_status.opportunities_24h }}</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Transactions (24h)</strong></td>
                                                                <td>{{ bot_data.bot_status.transactions_24h }}</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Errors (24h)</strong></td>
                                                                <td>{{ bot_data.bot_status.errors_24h }}</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="card mb-3">
                                            <div class="card-header bg-success text-white py-2">
                                                <h6 class="m-0">Profit Metrics</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-borderless table-sm">
                                                        <tbody>
                                                            <tr>
                                                                <td><strong>Total Profit</strong></td>
                                                                <td>{{ "%.4f"|format(bot_data.profit_summary.total_profit_eth) }} ETH</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>USD Value</strong></td>
                                                                <td>${{ "%.2f"|format(bot_data.profit_summary.total_profit_usd) }}</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Profitable Trades</strong></td>
                                                                <td>{{ bot_data.profit_summary.profitable_trades }}</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Average Profit</strong></td>
                                                                <td>{{ "%.4f"|format(bot_data.profit_summary.average_profit) }} ETH</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Last Profit</strong></td>
                                                                <td>{{ "%.4f"|format(bot_data.profit_summary.last_profit) }} ETH</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="card mb-3">
                                            <div class="card-header bg-primary text-white py-2">
                                                <h6 class="m-0">Gas Statistics</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-borderless table-sm">
                                                        <tbody>
                                                            <tr>
                                                                <td><strong>Avg Gas Used</strong></td>
                                                                <td>{{ bot_data.gas_statistics.average_gas_used }}</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Total Gas Used</strong></td>
                                                                <td>{{ bot_data.gas_statistics.total_gas_used }}</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Transactions</strong></td>
                                                                <td>{{ bot_data.gas_statistics.transactions_count }}</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Highest Gas</strong></td>
                                                                <td>{{ bot_data.gas_statistics.highest_gas_used }}</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Current Gas Price</strong></td>
                                                                <td>{{ gas_price }} Gwei</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Recent Transactions</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Transaction</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-transactions">
                                            {% if bot_data.recent_transactions %}
                                                {% for tx in bot_data.recent_transactions %}
                                                <tr>
                                                    <td>{{ tx.timestamp }}</td>
                                                    <td>
                                                        {% if tx.hash %}
                                                            {{ tx.hash[:10] }}...
                                                        {% elif tx.description %}
                                                            {{ tx.description }}
                                                        {% else %}
                                                            Transaction details not available
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr>
                                                    <td colspan="2" class="text-center">No recent transactions found</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Recent Opportunities</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Opportunity</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-opportunities">
                                            {% if bot_data.recent_opportunities %}
                                                {% for opp in bot_data.recent_opportunities %}
                                                <tr>
                                                    <td>{{ opp.timestamp }}</td>
                                                    <td>
                                                        {% if opp.description %}
                                                            {{ opp.description }}
                                                        {% else %}
                                                            Opportunity details not available
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr>
                                                    <td colspan="2" class="text-center">No recent opportunities found</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Trading Panel -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3 bg-success text-white d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold">Trading Panel</h6>
                                <div class="dropdown no-arrow">
                                    <button class="btn btn-sm btn-light" id="refreshOpportunities">
                                        <i class="bi bi-arrow-repeat"></i> Refresh Opportunities
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Trading Tabs -->
                                <ul class="nav nav-tabs" id="tradeTabContent" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="auto-trade-tab" data-bs-toggle="tab" data-bs-target="#auto-trade" type="button" role="tab" aria-controls="auto-trade" aria-selected="true">
                                            Auto Opportunity
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="manual-trade-tab" data-bs-toggle="tab" data-bs-target="#manual-trade" type="button" role="tab" aria-controls="manual-trade" aria-selected="false">
                                            Manual Trade
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="gas-settings-tab" data-bs-toggle="tab" data-bs-target="#gas-settings" type="button" role="tab" aria-controls="gas-settings" aria-selected="false">
                                            Gas Settings
                                        </button>
                                    </li>
                                </ul>
                                
                                <!-- Tab Content -->
                                <div class="tab-content" id="tradeTabContent">
                                    <!-- Auto Trade Tab -->
                                    <div class="tab-pane fade show active" id="auto-trade" role="tabpanel" aria-labelledby="auto-trade-tab">
                                        <div class="p-3">
                                            <h5>Available Arbitrage Opportunities</h5>
                                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                                <table class="table table-striped" id="opportunities-table">
                                                    <thead>
                                                        <tr>
                                                            <th>ID</th>
                                                            <th>Token</th>
                                                            <th>Buy DEX</th>
                                                            <th>Sell DEX</th>
                                                            <th>Profit %</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="opportunity-list">
                                                        <tr>
                                                            <td colspan="6" class="text-center">Loading opportunities...</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="alert alert-info mt-3">
                                                <i class="bi bi-info-circle-fill me-2"></i> Click "Execute" to take advantage of the opportunity. Make sure your wallet has sufficient funds.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Manual Trade Tab -->
                                    <div class="tab-pane fade" id="manual-trade" role="tabpanel" aria-labelledby="manual-trade-tab">
                                        <div class="p-3">
                                            <h5>Manual Trading</h5>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <form id="manual-trade-form">
                                                        <div class="mb-3">
                                                            <label for="token-address" class="form-label">Token Address</label>
                                                            <input type="text" class="form-control" id="token-address" placeholder="0x...">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="buy-dex" class="form-label">Buy DEX</label>
                                                            <select class="form-select" id="buy-dex">
                                                                {% for dex in active_dexes %}
                                                                <option value="{{ dex.name }}">{{ dex.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="sell-dex" class="form-label">Sell DEX</label>
                                                            <select class="form-select" id="sell-dex">
                                                                {% for dex in active_dexes %}
                                                                <option value="{{ dex.name }}">{{ dex.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="trade-amount" class="form-label">Amount (ETH)</label>
                                                            <input type="number" class="form-control" id="trade-amount" step="0.01" min="0.01" value="0.1">
                                                        </div>
                                                        <button type="button" class="btn btn-primary" id="analyze-trade-btn">Analyze</button>
                                                        <button type="button" class="btn btn-success" id="execute-trade-btn">Execute Trade</button>
                                                    </form>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card">
                                                        <div class="card-header bg-light">
                                                            <h6 class="m-0">Trade Analysis</h6>
                                                        </div>
                                                        <div class="card-body" id="trade-analysis">
                                                            <p class="text-center text-muted">Enter token details and click "Analyze" to see potential profit</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Gas Settings Tab -->
                                    <div class="tab-pane fade" id="gas-settings" role="tabpanel" aria-labelledby="gas-settings-tab">
                                        <div class="p-3">
                                            <h5>Gas Settings</h5>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <form id="gas-settings-form">
                                                        <div class="mb-3">
                                                            <label for="gas-price" class="form-label">Gas Price (Gwei)</label>
                                                            <input type="number" class="form-control" id="gas-price" value="{{ gas_price|float }}" step="0.1">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="max-fee" class="form-label">Max Fee Per Gas (Gwei)</label>
                                                            <input type="number" class="form-control" id="max-fee" value="{{ gas_price|float * 1.2 }}" step="0.1">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="priority-fee" class="form-label">Priority Fee (Gwei)</label>
                                                            <input type="number" class="form-control" id="priority-fee" value="1.5" step="0.1">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="gas-limit-multiplier" class="form-label">Gas Limit Multiplier</label>
                                                            <input type="number" class="form-control" id="gas-limit-multiplier" value="1.2" step="0.1" min="1.0" max="2.0">
                                                        </div>
                                                        <button type="button" class="btn btn-primary" id="update-gas-btn">Update Gas Settings</button>
                                                    </form>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card">
                                                        <div class="card-header bg-light">
                                                            <h6 class="m-0">Current Network Status</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <p><strong>Network:</strong> <span id="network-name">{{ network }}</span></p>
                                                            <p><strong>Current Gas Price:</strong> <span id="current-gas">{{ gas_price }}</span> Gwei</p>
                                                            <p><strong>Latest Block:</strong> <span id="latest-block">{{ block_number }}</span></p>
                                                            <p><strong>Wallet Balance:</strong> <span id="current-balance">{{ wallet_balance }}</span></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Network Information -->
                <div class="row mb-4">
                    <div class="col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Network Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless" id="network-info" width="100%" cellspacing="0">
                                        <tbody>
                                            <tr>
                                                <td><strong>Network</strong></td>
                                                <td id="network">{{ network }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Block Number</strong></td>
                                                <td id="block-number">{{ block_number }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Gas Price (Gwei)</strong></td>
                                                <td id="gas-price">{{ gas_price }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Wallet Address</strong></td>
                                                <td id="wallet-address">{{ wallet_address_short }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Allocation -->
                    <div class="col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Dynamic Allocation</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless" id="dynamic-allocation" width="100%" cellspacing="0">
                                        <tbody>
                                            <tr>
                                                <td><strong>Min Percentage</strong></td>
                                                <td>{{ min_percentage }}%</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Max Percentage</strong></td>
                                                <td>{{ max_percentage }}%</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Reserve</strong></td>
                                                <td>{{ reserve_percentage }}%</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Concurrent Trades</strong></td>
                                                <td>{{ concurrent_trades }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DEX Status -->
                <div class="row mb-4">
                    <div class="col-xl-8 col-lg-7">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Integrated DEXes</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>DEX Name</th>
                                                <th>Status</th>
                                                <th>Priority</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dex-list">
                                            {% if bot_data.dex_status %}
                                                {% for dex_name, dex_data in bot_data.dex_status.items() %}
                                                <tr>
                                                    <td>{{ dex_name }}</td>
                                                    <td>
                                                        <span class="badge {% if dex_data.status == 'Healthy' %}bg-success{% elif dex_data.status == 'Warning' %}bg-warning{% elif dex_data.status == 'Error' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                            {{ dex_data.status }}
                                                        </span>
                                                    </td>
                                                    <td>{{ dex_data.errors }} errors</td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                {% for dex in active_dexes %}
                                                <tr>
                                                    <td>{{ dex.name }}</td>
                                                    <td>
                                                        <span class="badge bg-success">{{ dex.status }}</span>
                                                    </td>
                                                    <td>{{ dex.priority }}</td>
                                                </tr>
                                                {% endfor %}
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gas Price Chart -->
                    <div class="col-xl-4 col-lg-5">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Gas Price (Gwei)</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-area">
                                    <canvas id="gasChart"></canvas>
                                </div>
                                <div class="mt-4 text-center small">
                                    <span class="mr-2">
                                        <i class="fas fa-circle text-primary"></i> Gas Price
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Errors -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 bg-danger text-white">
                                <h6 class="m-0 font-weight-bold">Recent Errors</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Module</th>
                                                <th>Error</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-errors">
                                            {% if bot_data.recent_errors %}
                                                {% for error in bot_data.recent_errors %}
                                                <tr>
                                                    <td>{{ error.timestamp }}</td>
                                                    <td>{{ error.module }}</td>
                                                    <td>{{ error.message }}</td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr>
                                                    <td colspan="3" class="text-center">No recent errors found</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="sticky-footer bg-white mt-5">
                    <div class="container my-auto">
                        <div class="copyright text-center my-auto">
                            <span>Arbitrage Bot Dashboard v1.0 | Last Updated: <span id="last-update">{{ current_time }}</span></span>
                        </div>
                    </div>
                </footer>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initial chart setup
        const ctx = document.getElementById('gasChart').getContext('2d');
        const gasChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ["-5m", "-4m", "-3m", "-2m", "-1m", "Now"],
                datasets: [{
                    label: 'Gas Price (Gwei)',
                    data: [
                        parseFloat("{{ gas_price }}".replace(/[^0-9.]/g, '') || 0),
                        parseFloat("{{ gas_price }}".replace(/[^0-9.]/g, '') || 0),
                        parseFloat("{{ gas_price }}".replace(/[^0-9.]/g, '') || 0),
                        parseFloat("{{ gas_price }}".replace(/[^0-9.]/g, '') || 0),
                        parseFloat("{{ gas_price }}".replace(/[^0-9.]/g, '') || 0),
                        parseFloat("{{ gas_price }}".replace(/[^0-9.]/g, '') || 0)
                    ],
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 3,
                    pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                    pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                    pointHitRadius: 10,
                    pointBorderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Auto-refresh data every 30 seconds
        setInterval(refreshData, 30000);

        // Update gas chart data
        const gasData = [];
        
        function updateGasChart(newPrice) {
            if (gasData.length >= 6) {
                gasData.shift();
            }
            gasData.push(newPrice);
            
            // Update chart data
            gasChart.data.datasets[0].data = gasData;
            gasChart.update();
        }
        
        // Debug panel toggle
        document.getElementById('toggleDebug').addEventListener('click', function() {
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
            } else {
                debugPanel.style.display = 'none';
            }
        });

        // Refresh data function
        function refreshData() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('status').textContent = data.status;
                    document.getElementById('uptime').textContent = data.uptime;
                    document.getElementById('wallet-balance').textContent = data.wallet_balance;
                    document.getElementById('total-profit').textContent = data.total_profit;
                    document.getElementById('network').textContent = data.network;
                    document.getElementById('gas-price').textContent = data.gas_price;
                    document.getElementById('block-number').textContent = data.block_number;
                    document.getElementById('wallet-address').textContent = data.wallet_address_short;
                    document.getElementById('last-update').textContent = data.current_time;
                    
                    // Update gas chart
                    updateGasChart(parseFloat(data.gas_price));
                 }
                })
                .catch(error => console.error('Error fetching data:', error));
        }
        
        // Load opportunities
        function loadOpportunities() {
            fetch('/api/profit-opportunities')
                .then(response => response.json())
                .then(data => {
                    const oppList = document.getElementById('opportunity-list');
                    if (!oppList) return;
                    
                    if (data.error) {
                        oppList.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${data.error}</td></tr>`;
                        return;
                    }
                    
                    if (!data.opportunities || data.opportunities.length === 0) {
                        oppList.innerHTML = `<tr><td colspan="6" class="text-center">No arbitrage opportunities found</td></tr>`;
                        return;
                    }
                    
                    oppList.innerHTML = '';
                    data.opportunities.forEach((opp, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${opp.id || index}</td>
                            <td>${opp.token_symbol || opp.token || 'Unknown'}</td>
                            <td>${opp.buy_dex || 'Unknown'}</td>
                            <td>${opp.sell_dex || 'Unknown'}</td>
                            <td>${opp.profit_percentage ? opp.profit_percentage.toFixed(2) + '%' : 'Unknown'}</td>
                            <td>
                                <button class="btn btn-sm btn-success execute-opp" data-id="${opp.id || index}">
                                    Execute
                                </button>
                            </td>
                        `;
                        oppList.appendChild(row);
                    });
                    
                    // Add event listeners to execute buttons
                    document.querySelectorAll('.execute-opp').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const oppId = this.getAttribute('data-id');
                            executeOpportunity(oppId);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching opportunities:', error);
                    const oppList = document.getElementById('opportunity-list');
                    if (oppList) {
                        oppList.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error fetching opportunities</td></tr>`;
                    }
                });
        }
        
        // Execute arbitrage opportunity
        function executeOpportunity(opportunityId) {
            if (!confirm('Are you sure you want to execute this arbitrage opportunity?')) {
                return;
            }
            
            fetch('/api/execute-opportunity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ opportunity_id: opportunityId })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.status || 'Opportunity execution started');
            })
            .catch(error => {
                console.error('Error executing opportunity:', error);
                alert('Error executing opportunity');
            });
        }
        
        // Analyze trade potential
        function analyzeTradeProfit() {
            const tokenAddress = document.getElementById('token-address').value;
            if (!tokenAddress) {
                alert('Please enter a token address');
                return;
            }
            
            const analysisDiv = document.getElementById('trade-analysis');
            analysisDiv.innerHTML = '<p class="text-center"><i class="bi bi-hourglass-split"></i> Analyzing...</p>';
            
            fetch(`/api/profit-analysis/${tokenAddress}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        analysisDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        return;
                    }
                    
                    analysisDiv.innerHTML = `
                        <div class="alert alert-info">
                            <p><strong>Best Buy:</strong> ${data.buy_dex} (${data.buy_price.toFixed(8)})</p>
                            <p><strong>Best Sell:</strong> ${data.sell_dex} (${data.sell_price.toFixed(8)})</p>
                            <p><strong>Profit Potential:</strong> ${data.profit_percentage.toFixed(2)}%</p>
                        </div>
                        <p class="text-center">
                            <button class="btn btn-sm btn-outline-success" id="use-best-path">Use This Path</button>
                        </p>
                    `;
                    
                    // Add event listener to use best path button
                    document.getElementById('use-best-path')?.addEventListener('click', function() {
                        document.getElementById('buy-dex').value = data.buy_dex;
                        document.getElementById('sell-dex').value = data.sell_dex;
                    });
                })
                .catch(error => {
                    console.error('Error analyzing trade:', error);
                    analysisDiv.innerHTML = '<div class="alert alert-danger">Error analyzing trade</div>';
                });
        }
        
        // Execute manual trade
        function executeManualTrade() {
            const tokenAddress = document.getElementById('token-address').value;
            const buyDex = document.getElementById('buy-dex').value;
            const sellDex = document.getElementById('sell-dex').value;
            const amount = parseFloat(document.getElementById('trade-amount').value);
            
            if (!tokenAddress) {
                alert('Please enter a token address');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (buyDex === sellDex) {
                alert('Buy and sell DEXes must be different');
                return;
            }
            
            if (!confirm(`Are you sure you want to execute this trade?\n\nBuy: ${buyDex}\nSell: ${sellDex}\nAmount: ${amount} ETH`)) {
                return;
            }
            
            fetch('/api/execute-trade', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    buy_dex: buyDex,
                    sell_dex: sellDex,
                    token_address: tokenAddress,
                    amount: amount
                })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.status || 'Trade execution started');
            })
            .catch(error => {
                console.error('Error executing trade:', error);
                alert('Error executing trade');
            });
        }
        
        // Update gas settings
        function updateGasSettings() {
            const gasPrice = parseFloat(document.getElementById('gas-price').value);
            const maxFee = parseFloat(document.getElementById('max-fee').value);
            const priorityFee = parseFloat(document.getElementById('priority-fee').value);
            const gasLimitMultiplier = parseFloat(document.getElementById('gas-limit-multiplier').value);
            
            fetch('/api/update-gas-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    gas_price: Math.floor(gasPrice * 1e9), // Convert to wei
                    max_fee_per_gas: Math.floor(maxFee * 1e9),
                    max_priority_fee: Math.floor(priorityFee * 1e9),
                    gas_limit_multiplier: gasLimitMultiplier
                })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.status || 'Gas settings updated');
            })
            .catch(error => {
                console.error('Error updating gas settings:', error);
                alert('Error updating gas settings');
            });
        }
        
        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initial data load
            loadOpportunities();
            
            // Refresh opportunities button
            document.getElementById('refreshOpportunities')?.addEventListener('click', loadOpportunities);
            
            // Analyze trade button
            document.getElementById('analyze-trade-btn')?.addEventListener('click', analyzeTradeProfit);
            
            // Execute trade button
            document.getElementById('execute-trade-btn')?.addEventListener('click', executeManualTrade);
            
            // Update gas settings button
            document.getElementById('update-gas-btn')?.addEventListener('click', updateGasSettings);
        });

        // Debug panel toggle
        document.getElementById('toggleDebug')?.addEventListener('click', function() {
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
            } else {
                debugPanel.style.display = 'none';
            }
        });

        // Refresh data function
        function refreshData() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update other bot data if needed
                    if (data.bot_data) {
                        // Update bot status, transactions, opportunities, errors, etc.
                        // This would require updating DOM elements with the new data
                    }
                    
                    // Update network information
                    document.getElementById('network-name').textContent = data.network;
                    document.getElementById('current-gas').textContent = data.gas_price;
                    document.getElementById('latest-block').textContent = data.block_number;
                    document.getElementById('current-balance').textContent = data.wallet_balance;
                    
                    // Update gas chart
                    updateGasChart(parseFloat(data.gas_price));
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // Add click handler for the refreshBotStatus button
        document.getElementById('refreshBotStatus')?.addEventListener('click', function() {
            refreshData();
        }
);
    </script>
</body>
</html>